import{C as p,_ as Q}from"./ddd@DwDq534T.js";var H=window.debug;const re="ddd/system_assets/icons/";function ie(s,t,d,l,f){if(t=t||"",s.isFile)f.counter++,s.file(function(r){d(t+r.name,r),f.counter--,f.counter==0&&f.finish()});else if(s.isDirectory){let h=function(){f.counter++,r.readEntries(function(c){if(c?.length>0){for(let m=0;m<c.length;m++)ie(c[m],t+s.name+"/",d,l,f);h()}f.counter--,H&&console.log(f),f.counter==0&&f.finish()})};l(t+s.name);let r=s.createReader();h()}}function te(s,t,d,l){let f=0;const r=s.length;if(H&&console.log("get_items",s.length,t.length,d.length),r>0)for(let h=0;h<s.length;h++){const c=s[h].webkitGetAsEntry();c&&ie(c,null,(m,P)=>{d.push({file:P,file_path:m})},m=>{t.push(m),H&&console.log("Dir",m)},{counter:0,finish:()=>{f++,H&&console.log(f==r,f,r),f==r&&(H&&console.log("finish"),l?l():H&&console.log("No end callback"))}})}else l&&l()}function oe(s){const t=s.currentTarget;if(console.log(t.dataset.absolute_path),t.dataset.absolute_path!=null){s.dataTransfer.setData("json",JSON.stringify({items:[t.dataset.absolute_path],target_file_paths:[{absolute_path:t.dataset.absolute_path,is_directory:t.dataset.is_directory=="true"}]}));{const d=document.getElementsByClassName("file_browser_item");let l=null;const f=t.dataset.absolute_path;for(let r=0;r<d.length;r++)if(d[r].dataset.absolute_path==f){l=d[r];break}l&&l.classList.contains("active")==!1&&l.onmouseup(s)}}}async function ae(s,t,d=window.file_browser,l=f=>{}){t&&t.stopPropagation(),t&&t.preventDefault();const f=d,r=window.external_io,h=t.is_main_screen||t?.target instanceof HTMLCanvasElement;if(r&&h){let T="/tmp";r.driver=="indexeddb"?(await r.mkdir(T,{recursive:!0}),await f.file_browser(T)):r.driver=="memory"?(await r.mkdir(T,{recursive:!0}),await f.file_browser(T)):r.driver=="webdav"?(await r.mkdir(T,{recursive:!0}),await f.file_browser(T)):r.driver=="aws_s3"?(await r.mkdir(T,{recursive:!0}),await f.file_browser(T)):r.driver=="websocketfs"?(await r.mkdir(T,{recursive:!0}),await f.file_browser(T)):console.warn(r.driver,"tried to create tmp directory. But not supported.")}p.modal_processing("Uploading....",""),H&&console.log(t),d.right_dom.style.opacity=1;const c=t.dataTransfer.getData("json"),m=t.dataTransfer.types.includes("Files"),P=t.dataTransfer.types.includes("json"),x=p.clone(t.dataTransfer.types);console.log(c,t.dataTransfer,m,P,x);let b=[];if(P&&c.length>0){H&&console.log("JSON");const T=JSON.parse(c);b=b.concat(T.target_file_paths)}else if(m)if(H&&console.log("FILES",t.dataTransfer,t.dataTransfer.items),t.dataTransfer.items){const T=t.dataTransfer.items,z=[],A=[];if(window.nodejs){H&&console.log("Get files on electron");const e=window.nodejs.fs;e.promises,window.nodejs.path,H&&console.log("FILES",t.dataTransfer.files);for(let _=0;_<t.dataTransfer.files.length;_++){let o=t.dataTransfer.files[_].path;o=o.replace(/\\/g,"/");const v=e.lstatSync(o);if(v.isSymbolicLink()){const E=p.DPath(o).dirname,M=window.nodejs.glob.sync(p.path.join(o,"**/*")),L={};for(const g of M){L[p.DPath(g).dirname]=!0;const n=window.nodejs.fs.lstatSync(g).isDirectory();A.push({file_path:g.slice(E.length,g.length),absolute_path:g,is_directory:n})}for(const g in L){const n=p.DPath(g);z.push({absolute_path:n.path,file_path:n.path.slice(E.length,n.path.length)})}}else if(v.isDirectory()){const E=p.DPath(o).dirname,M=window.nodejs.glob.sync(p.path.join(o,"**/*"),{dot:!0,follow:!0}),L={};for(const g of M){L[p.DPath(g).dirname]=!0;const n=window.nodejs.fs.lstatSync(g).isDirectory();A.push({file_path:g.slice(E.length,g.length),absolute_path:g,is_directory:n})}for(const g in L){const n=p.DPath(g);z.push({absolute_path:n.path,file_path:n.path.slice(E.length,n.path.length)})}}else{const y=p.DPath(o).dirname,E=o;A.push({file_path:E.slice(y.length,E.length),absolute_path:E})}}}else{if(H&&console.log("Get files from browser"),t.is_main_screen)t.dataTransfer.dirs.forEach(async e=>{z.push(e)}),t.dataTransfer.files.forEach(async e=>{A.push(e)});else{let e=!1;for(te(T,z,A,()=>{e=!0});!e;)await p.sleep(100)}H&&console.log("FILES",T,z,A)}let N=[];if(H&&console.log(T,z,A),z.length>0)for(const e of z)if(f.current_link)if(window.nodejs){const _=p.DPathJoin(f.current_link,e.file_path);H&&console.log(_),await r.mkdir(_)}else{const _=p.DPathJoin(f.current_link,e);H&&console.log(_),await r.mkdir(_,!0)}else N.push(async()=>{});if(await Promise.all(N),N=[],p.close_modal_processing(),H&&console.log(A),A.length>0){p.modal_processing("Uploading","");const e='<progress id="_upload_processing_" max="1" value="0" style="width:100%;margin:0px;padding:0px;height:4px"></progress>';H&&console.log("Uploading");{const _=A.length;let a=0;const o=function(i,u){return new Promise(function(k,w){if(window.nodejs){const j=window.nodejs.fs,S=p.DPathJoin(f.current_link,i.file_path),D=S.split("/").pop();i.is_directory?k({size:0}):j.readFile(i.absolute_path,async($,B)=>{if($){console.error($),w($);return}u&&await u("fetched",B.length);const I=B;let q=!0;if(D[0]=="."?(D.length==1||D[0]=="."&&D[1]=="/")&&(q=!1):D=="Thumbs.db"&&(q=!1),q==!1){k({size:I.length});return}await r.put(S,I),k({size:I.length})})}else{const j=new FileReader;j.onload=async function(S){const D=S.target.result;let $=-1;D instanceof ArrayBuffer?$=D.byteLength:typeof D=="string"&&($=D.length),u&&await u("fetched",$);const B=p.DPathJoin(f.current_link,i.file_path),I=B.split("/").pop();let q=!0;if(I[0]=="."?(I.length==1||I[0]=="."&&I[1]=="/")&&(q=!1):I=="Thumbs.db"&&(q=!1),q==!1){k({size:$});return}await r.put(B,D),k({size:$})},j.onerror=async function(S){w(S)},j.readAsArrayBuffer(i.file)}})};let v=!0;p.modal_processing("Uploading",""),await Q(()=>import("./jszip.min@TY6z0PXt.js"),[],import.meta.url);const y=[],E=async function(i){if(i.update(),A.length==1&&h){await p.sleep(100),p.modal_processing("Processing...."),await p.sleep(100),await p.extract_zip(y),p.close_modal_processing();for(const u of y)A.push({store_path:u})}p.close_modal_processing(),console.log(b),l?.(A)},O=32;let M=1024*1024*50;(r.driver=="indexeddb"||r.driver=="memory")&&(M=1024*1024*1024);let L=0,g=0;const n=async function(i,u){for(;L>M;)await p.sleep(1e3);L+=u};for(const i of A){const u=p.DPathJoin(f.current_link,i.file_path);i.store_path=u;const k=function(w,j){p.modal_processing_update_description(w);const S=document.getElementById("_upload_processing_");S instanceof HTMLProgressElement&&(S.value=j)};v&&(v=!0,k(`${e}<br>${a}/${_} : ${i.file_path}`,a/_));{for(;g!=0&&(g>O||L>M);)await p.sleep(30);g++,o(i,n).then(w=>{g--,L-=w.size,a++,k(`${e}<br>${a}/${_} : ${i.file_path}`,a/_),p.DPath(i.file_path).ext.toLowerCase()=="zip"&&y.push(i.store_path),b.push(i.file_path),a==_&&E(f)}).catch(w=>{g--,a++,k(`${e}<br>${a}/${_} : ${i.file_path}`,a/_),a==_&&E(f)})}}return A}}else H&&console.log("No items")}else{H&&console.log("Electron");for(let T=0;T<t.dataTransfer.files.length;T++)b.push(t.dataTransfer.files[T])}return p.close_modal_processing(),b}function Y(s,t,d,l){let f=null,r=!1;for(let h of l){let c=h.absolute_path.replace(/\\/g,"/");if(f=s+"/"+t+d,c==f){d++,r=!0;break}}return r?Y():f}async function Z(s,t,d=window.file_browser){H&&console.log("drop_handler"),t.stopPropagation(),t.preventDefault(),s.classList.remove("dragover");const l=t.dataTransfer.getData("json");if(t.dataTransfer.types.includes("Files"),t.dataTransfer.types.includes("json")&&l.length>0){JSON.parse(l),d.right_dom.style.opacity=1;const r=s.dataset?.absolute_path;if(H&&console.log("drop_handler",r),r){const h=document.querySelectorAll(".file_browser_item.active");for(let c=0;c<h.length;c++){const m=h[c].dataset.absolute_path,P=r;if(H&&console.log(m,P),P==m){document.body.style.cursor=null,H&&console.log("Same directory");return}}p.modal_processing("Processing","");for(let c=0;c<h.length;c++){const m=h[c];if(m instanceof HTMLElement){const P=m.dataset.absolute_path.split("/").pop();let x="";r.length>0?x=r[r.length-1]=="/"?r+P:r+"/"+P:x=P;const b=async function(T){try{if(await d.io.move(T.dataset.absolute_path,x,T.dataset.is_directory=="true",T.dataset.is_directory=="true"),T.dataset.is_directory!="true"){const z=p.make_thumbnail_path(T.dataset.absolute_path),A=p.make_thumbnail_path(x);await d.io.exists(z)&&d.io.move(z,A)}}catch(z){console.error(z)}await d.update()};x!=m.dataset.absolute_path&&(document.body.style.cursor="progress",await d.io.exists(x)?(p.close_modal_processing(),await p.modal_ok_cancel_promise("Overwrite","Are you sure to overwrite?",{})&&await b(m),document.body.style.cursor=null,p.modal_processing("Processing","")):(await b(m),document.body.style.cursor=null))}}await p.sleep(100),p.close_modal_processing()}}}function ee(s){s.target.classList.add("dragover"),s.stopPropagation(),s.preventDefault()}function W(s){s.target.classList.remove("dragover"),s.stopPropagation(),s.preventDefault()}async function ce(s,t=!1){const d=window.nodejs.fs,l=window.external_io,f=await window.cross_file_system.open_dialog({defaultPath:await __storage__.editor_permanent.get("previous_sync_to_local_directory"),properties:["openDirectory"]});if(f?.length==1){const r=p.DPath(f[0]).path;await __storage__.editor_permanent.set("previous_sync_to_local_directory",r),p.modal_processing("Processing","");const h=document.querySelectorAll(t?".file_browser_dir_item.active":".file_browser_item.active"),c=[];for(let P=0;P<h.length;P++){const x=h[P];if(x instanceof HTMLElement)if(x.dataset.is_directory=="true"){const b=await l.list(x.dataset.absolute_path,{recursive:!0});for(const T of b)if(T.basename[0]!="."){const z=p.file_type(T.absolute_path);if(z=="project"||z=="model"||z=="j_object"){const A=p.make_thumbnail_path(T.absolute_path);c.push({is_directory:!1,absolute_path:A})}c.push({is_directory:T.is_directory,absolute_path:T.absolute_path})}}else c.push({is_directory:!1,absolute_path:x.dataset.absolute_path})}const m=s[s.length-1]=="/"?s:s+"/";if(c.filter(P=>P.is_directory).length==0&&c.length==1){const P=p.path.join(m,c[0].absolute_path.split("/").pop());if(!d.existsSync(P)){const x=await l.get(c[0].absolute_path);d.mkdirSync(p.DPath(P).dirname,{recursive:!0}),d.writeFileSync(P,window.nodejs.to_nodejs_buffer(x))}p.close_modal_processing()}else{const P='<progress id="_processing_" max="1" value="0" style="width:100%;margin:0px;padding:0px;height:4px"></progress>',x='<progress id="_processing2_" max="1" value="0" style="width:100%;margin:0px;padding:0px;height:4px"></progress><div id="_processing3_" style="width:100%;text-align:center"></div>';let b=0,T=0,z=0;const A=new Set,N=1;for(const e of c)if(e.is_directory){const _=e.absolute_path.slice(m.length),a=p.path.join(r,_),o=p.DPath(a).dirname;d.existsSync(o)||d.mkdirSync(o,{recursive:!0})}else T++;for(const e of c){for(;z>N;)await p.sleep(50);l.gc_cache?.();const _=e.absolute_path.slice(m.length);if(!e.is_directory){H&&console.log(_),z++,p.modal_processing_update_description(`${P}<br>${x}<br>${b}/${T} : ${e.absolute_path}`),T&&(document.getElementById("_processing_").value=b/T);try{const a=p.path.join(r,_);if(d.existsSync(a))z--;else{const o=await window.cross_file_system.read(e.absolute_path,{listener:{progress:function(y,E){E>0?document.getElementById("_processing2_").value=y/E:document.getElementById("_processing2_").value=1,document.getElementById("_processing3_").innerHTML=`${y}/${E} bytes`}}}),v=p.DPath(a).dirname;A.has(v)||(A.add(v),d.existsSync(v)||(H&&console.log("Mkdir",v),d.mkdirSync(v,{recursive:!0}))),H&&console.log(b,T,v,a),d.writeFile(a,Buffer.from(o),y=>{y&&console.error(y),z--})}}catch(a){a&&console.error(a),z--}b++}}}p.close_modal_processing()}}async function le(s,t,d){await Q(()=>import("./jszip.min@TY6z0PXt.js"),[],import.meta.url),p.modal_processing("Downloading","");const l=[];for(let f=0;f<s.length;f++){const r=s[f];if(r instanceof HTMLElement)if(r.dataset.is_directory=="true"){const h=await window.cross_file_system.list(r.dataset.absolute_path,{recursive:!0});for(const c of h)c.basename[0]!="."&&l.push({data:null,relative_path:null,is_directory:c.is_directory,absolute_path:c.absolute_path})}else l.push({data:null,relative_path:null,is_directory:!1,absolute_path:r.dataset.absolute_path})}if(l.filter(f=>f.is_directory).length==0&&l.length==1)await p.download(await window.cross_file_system.read(l[0].absolute_path),l[0].absolute_path.split("/").pop()),p.close_modal_processing();else{const f=new JSZip,r=[];let h=`
		<progress id="_processing_" max="1" value="0" style="width:100%;margin:0px;padding:0px;height:4px"></progress><br>
		<progress id="_processing2_" max="1" value="0" style="width:100%;margin:0px;padding:0px;height:4px"></progress><br>
		<div id="_processing3_" style="width:100%;text-align:center"></div>
		`,c=0;for(const m of l)if(m.relative_path=m.absolute_path.slice(d.length),!m.is_directory){H&&console.log(c,r.length),p.modal_processing_update_description(`${h}<br>${c}/${r.length} : ${m.relative_path}`);let P=0;if(m.data=await window.cross_file_system.read(m.absolute_path,{listener:{progress:function(x,b){const T=document.getElementById("_processing2_");T instanceof HTMLProgressElement&&(b>0?T.value=x/b:T.value=1),P++%3==0&&(document.getElementById("_processing3_").innerHTML=`${Math.floor(x/1024).toLocaleString()} / ${Math.floor(b/1024).toLocaleString()} KB`)}}}),r.length){const x=document.getElementById("_processing_");x instanceof HTMLProgressElement&&(x.value=c/r.length)}c++}p.close_modal_processing(),p.modal_processing("Compressing",""),h=`
		<progress id="_processing_" max="1" value="0" style="width:100%;margin:0px;padding:0px;height:4px"></progress>
		`,c=0;for(const m of l)H&&console.log(m.relative_path),m.is_directory?(p.modal_processing_update_description(`${h}<br>${c}/${l.length} : ${m.relative_path}`),l.length&&(document.getElementById("_processing_").value=c/l.length)):(p.modal_processing_update_description(`${h}<br>${c}/${l.length} : ${m.relative_path}`),f.file(m.relative_path,m.data),l.length&&(document.getElementById("_processing_").value=c/l.length)),await p.sleep(16),c++;p.modal_processing_update_description("Compressing....."),f.generateAsync({type:"blob",compression:"DEFLATE"}).then(async function(m){await p.download(m,t+".zip"),p.close_modal_processing()}).catch(m=>{console.error(m),p.close_modal_processing()})}}async function de(s,t,d={}){const l={force_open_tree:!1};Object.assign(l,d),s.directory_browser_current_path=t;const f=s.left_dom;f.innerHTML="";const r=s.io;let h=null;f.onmouseup=async b=>{if(b.button==2){const T=[],z=await window.cross_file_system.list(t);T.push({key:"Make a new folder",callback:async()=>{const e=Y(t,"New folder ",1,z),_=e.split("/").pop();await window.cross_file_system.mkdir(e),await s.update();const a=f.querySelectorAll(".file_browser_dir_item > span");for(let o=0;o<a.length;o++){const v=a[o];if(v.innerText==_){console.log("scrollIntoView"),v.parentElement.scrollIntoView({}),v.parentElement.querySelector("button").click();break}}}}),C.popup_menu(b,T,null,(A,N,e)=>{e.callback()}),b.stopPropagation()}};function c(b){if(b.item&&b.item.remove(),b.children)for(const T of b.children)c(T)}function m(b,T,z,A,N){if(b.is_directory){T.children.push(b);const e=document.createElement("div"),_=document.createElement("i"),a=document.createElement("i"),o=document.createElement("span"),v=document.createElement("button");b.item=e,b.toggle=_,e.draggable=!0,e.ondragstart=oe,e.classList.add("file_browser_dir_item"),_.classList.add("file_browser_dir_toggle"),_.classList.add("bi"),_.dataset.absolute_path=b.absolute_path,(async()=>(await r.list(b.absolute_path)).filter(M=>M.is_directory).length!=0&&(_.classList.add("bi-caret-right-fill"),_.onmouseup=async function(M){if(M&&M.stopPropagation(),_.classList.contains("bi-caret-right-fill")){if(_.classList.add("bi-caret-down-fill"),_.classList.remove("bi-caret-right-fill"),await P(b.absolute_path,e,b,A+1),M)for(const g of b.children)g.item.style.opacity=0;const L=function(g){g>1&&(g=1);for(const n of b.children)n.item.style.opacity=g;g<1&&setTimeout(()=>{L(g+.1)},16)};M&&L(.4),s.left_directory_collapse_table[b.absolute_path]=!0,s.event_listener&&await s.event_listener({name:"modified_directory_browser"})}else{if(_.classList.add("bi-caret-right-fill"),_.classList.remove("bi-caret-down-fill"),M)for(const g of b.children)g.item.style.opacity=1;const L=function(g){g<.5&&(g=.4);for(const n of b.children)n.item.style.opacity=g;if(g>.5)setTimeout(()=>{L(g-.1)},16);else if(b.children)for(const n of b.children)c(n)};if(M)L(1);else if(b.children)for(const g of b.children)window.debug_file_browser&&console.log(g.basename),c(g);delete s.left_directory_collapse_table[b.absolute_path],s.event_listener&&await s.event_listener({name:"modified_directory_browser"})}},(l.force_open_tree||s.left_directory_collapse_table[b.absolute_path]||s.entry_point==b.absolute_path)&&setTimeout(()=>{_.onmouseup(null)},0)))(),a.classList.add("file_browser_dir_icon"),a.classList.add("bi"),a.classList.add("bi-folder-fill"),o.classList.add("file_browser_dir_text"),o.innerText=b.basename,e.style.width=`calc(100% - ${A*10}px)`,e.style.paddingLeft=`${A*10}px`,v.style.display="none",v.onclick=function(O){y.style.display=E,o.style.display="none",y.style.backgroundColor="#555",y.value=o.innerText,y.focus()},e.ondrop=function(O){Z(this,O,s)},e.ondragover=ee,e.ondragleave=W,e.ondragend=W,e.appendChild(v),e.classList.add("no_select"),e.dataset.absolute_path=b.absolute_path,e.dataset.is_directory=b.is_directory,e.onmouseup=function(O){window.debug_file_browser&&console.log(e.innerText);const M=O.ctrlKey||O.metaKey||O.shiftKey;if(O.button!=2||h==null||h!=e&&M){const L=f.querySelectorAll(".file_browser_dir_item");if(O.ctrlKey||O.metaKey)h=e,e.classList.add("active");else if(O.shiftKey){let g=0,n=0;for(let i=0;i<L.length;i++)L[i].classList.remove("active"),e==L[i]&&(n=i),h==L[i]&&(g=i);if(g>n){const i=g;g=n,n=i}for(;g<=n;)L[g].classList.add("active"),g++}else{for(let g=0;g<L.length;g++)L[g].classList.remove("active");h=e,e.classList.add("active")}}if(s.push_link_stack(b.absolute_path),s.file_browser(b.absolute_path),O.button==2){const L=[];b.protocol=="local"&&L.push({key:"Open in Folder",callback:()=>{window.nodejs.open_in_finder(b.absolute_path)}}),b.protocol=="local"&&L.push({key:"---",callback:()=>{}}),L.push({key:"Make a new folder",callback:async()=>{let g=1;const n="New folder ",i=await r.list(b.absolute_path),u=Y(t,n,g,i),k=u.split("/").pop();await r.mkdir(u),await s.update();const w=f.querySelectorAll(".file_browser_dir_item > span");for(let j=0;j<w.length;j++){const S=w[j];if(S.innerText==k){console.log("scrollIntoView"),S.parentElement.scrollIntoView({}),S.parentElement.querySelector("button").click();break}}}}),b.is_directory&&L.push({key:"Open in Asset Browser",callback:async()=>{s.event_listener&&await s.event_listener({name:"open_in_asset_browser",search_path:b.absolute_path})}}),L.push({key:"---",callback:()=>{}}),L.push({key:"Download",callback:async()=>{const g=document.querySelectorAll(".file_browser_dir_item.active"),n=t[t.length-1]=="/"?t:t+"/",i=b.absolute_path.split("/").pop().split(".").shift();le(g,i,n)}}),L.push({key:"Sync to local",callback:()=>{ce(t,!0)}}),L.push({key:"---",callback:()=>{}}),L.push({key:"Rename",callback:()=>{v.click()}}),L.push({key:"<span style='float:left'>Delete</span><span style='float:right;color:gray'>D</span>",value:"Delete",callback:()=>{C.modal_ok_cancel("Delete",`Are you sure?<br><br>'${b.absolute_path}'<br>It will be deleted without moving to the Trash.`,{},async g=>{if(g){const n=f.querySelectorAll(".file_browser_dir_item.active");for(let i=0;i<n.length;i++){const u=n[i];await r.remove(u.dataset.absolute_path,u.dataset.is_directory=="true"),h=null}s.update()}})}}),L.push({key:"Copy",callback:async()=>{const n=window.file_browser.get_selected_items_from("directory").map(i=>({is_directory:i.dataset.is_directory=="true",absolute_path:i.dataset.absolute_path}));await navigator.clipboard.writeText(JSON.stringify({file_browser:!0,contents:n}))}}),L.push({key:"Duplicate",callback:async()=>{let g=1;const n=b.absolute_path.replace(/\\/g,"/"),i=n.indexOf("/")==-1?n:n.slice(n.lastIndexOf("/")+1),u=n.indexOf("/")==-1?"":n.slice(0,n.lastIndexOf("/"));let k=i.lastIndexOf(".")==-1?"":i.slice(i.lastIndexOf("."));const w=u.slice(u.lastIndexOf(".tar.gz"));w==".tar.gz"&&(k=w);const j=await r.list(b.absolute_path);function S(){let $=!1;for(const B of j){const I=u+`/${i.slice(0,i.length-k.length)} Copied ${g}${k}`;if(B.absolute_path.replace(/\\/g,"/")==I){g++,$=!0;break}}$&&S()}S();const D=u+`/${i.slice(0,i.length-k.length)} Copied ${g}${k}`;if(await r.copy(b.absolute_path,D,b.is_directory,b.is_directory),!b.is_directory){const $=C.make_thumbnail_path(b.absolute_path),B=C.make_thumbnail_path(D);await r.exists($)&&r.copy($,B)}if(T.children)for(const $ of T.children)window.debug_file_browser&&console.log($.basename),c($);await P(t,z,T,A)}}),C.popup_menu(O,L,{event_listener:g=>{if(g.button==null&&g.code=="KeyD")for(const n of L)n.value=="Delete"&&n.callback()}},(g,n,i)=>{i.callback()})}O.stopPropagation()};const y=document.createElement("input");let E="flex";y.style.backgroundColor="#00000000",y.style.fontSize=o.style.fontSize,y.classList.add("file_browser_dir_text"),y.value=o.innerText,e.appendChild(_),e.appendChild(a),e.appendChild(o),e.appendChild(y),y.style.display="none",o.style.display=E,y.onblur=function(){y.style.display="none",o.style.display=E,y.style.backgroundColor="#00000000"},y.onchange=async function(){const O=y.value;if(O.length==0){y.value=o.innerText;return}if(["/","\\","<",">",":","'","?","*"].filter(L=>O.indexOf(L)>=0).length>0){console.error("Invalid char is including.");return}try{let L=b.absolute_path;if(window.nodejs){const g=window.nodejs.path.dirname(L);L=window.nodejs.path.join(g,y.value)}else L.lastIndexOf("/")!=-1&&(L=L.slice(0,L.lastIndexOf("/"))),L.length&&(L+="/"),L+=y.value;if(await r.move(b.absolute_path,L,b.is_directory,b.is_directory),!b.is_directory){const g=C.make_thumbnail_path(b.absolute_path),n=C.make_thumbnail_path(L);await r.exists(g)&&r.move(g,n)}delete s.data_cache_table[b.absolute_path],b.absolute_path=L,o.innerText=y.value,s.update(!1,!0),window.debug_file_browser&&console.log(o.innerText)}catch(L){console.error(L),alert(L)}},y.onkeydown=function(O){O.key=="Enter"&&(y.blur(),O.preventDefault(),O.stopPropagation())},z?(f.insertBefore(e,N.next_sibling.nextSibling),N.next_sibling=N.next_sibling.nextSibling):f.appendChild(e)}}async function P(b,T,z,A){z.children=[];const N=await r.list(b);N.sort((e,_)=>e.basename<_.basename?-1:e.basename>_.basename?1:e.date<_.date?-1:e.date>_.date?1:0);for(const e of N)e.basename[0]!="."&&m(e,z,T,A,{next_sibling:T})}const x={children:[]};m({absolute_path:t,basename:t,date:0,ext:"",id:t,is_directory:!0,is_file:!1,prefix:void 0,protocol:r.driver,relative_path:t},x,null,0,{next_sibling:null})}var R=window.debug;function V(s){const t=document.createElement("i");return t.classList.add("bi"),t.classList.add("bi-4x"),t.classList.add(s),t.style.margin="5px",t.style.marginBottom="8px",t}async function ne(s,t,d={cache:!0}){const l=re,f=d.cache;s.file_browser_current_path=t,t=t.replace(/\\/g,"/"),s.event_listener&&await s.event_listener({name:"file_browser",file_browser_current_path:t}),console.log("Open:",t,d);const r=s.breadcrumb_dom;if(r){t[0]!="/"&&(t="/"+t);const e=t.split("/"),_=[];s.parent_link=null,r.innerHTML="";for(let a=0;a<e.length;a++){_.push(e[a]);let o=_.join("/");o=o.length==0?"/":o;const v=document.createElement("a");if(v.style.cssText="font-size:10px;cursor:pointer;",v.classList.add("file_browser_breadcrumb_link"),v.classList.add("no_select"),e[a].length==0&&a==0)v.innerText="ROOT";else{if(e[a].length==0)continue;v.innerText=`/${e[a]}`}t!=o&&(v.onclick=function(y){s.push_link_stack(o),s.file_browser(o)}),v.dataset.absolute_path=o,v.dataset.is_directory="true",v.ondrop=function(y){Z(v,y,s)},v.ondragover=ee,v.ondragleave=W,v.ondragend=W,v.onmousedown=y=>{v.classList.add("file_browser_breadcrumb_link_clicked")},v.onmouseup=y=>{v.classList.remove("file_browser_breadcrumb_link_clicked")},r.appendChild(v),a+1<e.length&&(s.parent_link=o),s.current_link=o}}const h=s.explore_preview_dom;if(!s.explore_preview_dom)return;let c=null;document.body.style.cursor="progress";const m=s.io,P=await m.list(t);function x(e){return e=="mmd"||e=="ddd"||e=="object"||e=="material"||e=="pmx"||e=="pmd"||e=="blend"||e=="lwo"||e=="dae"||e=="fbx"||e=="3ds"||e=="vrm"||e=="gltf"||e=="glb"||e=="stl"||e=="obj"||e=="mtl"||e=="drc"||e=="vmd"||e=="vpd"?1:e=="png"||e=="jpg"||e=="jpeg"||e=="webp"||e=="avif"||e=="tiff"||e=="tif"||e=="tga"||e=="bmp"||e=="gif"||e=="ktx"||e=="ktx2"?2:e=="mp3"||e=="aac"||e=="aiff"||e=="3gp"||e=="flac"||e=="m4a"||e=="ogg"||e=="wav"||e=="webm"||e=="wma"?3:e=="mp4"||e=="mkv"||e=="mov"||e=="avi"||e=="webm"?4:9}P.sort((e,_)=>{if(e.is_directory||_.is_directory){if(e.is_directory&&!_.is_directory)return-1;if(!e.is_directory&&_.is_directory)return 1}const a=e.ext.toLowerCase(),o=_.ext.toLowerCase(),v=e.basename.toLowerCase(),y=_.basename.toLowerCase();return x(a)<x(o)?-1:x(a)>x(o)?1:v<y?-1:v>y?1:0});let b=!0;const T=[];for(const e of P){if(e.basename[0]==".")continue;const _=document.createElement("div");_.classList.add("block"),b&&(b=!1,_.classList.add("active"),setTimeout(function(){},100));let a=e.ext.toLowerCase();a=a=="jpg"?"jpeg":a,a=a=="tif"?"tiff":a;let o=null;const v=document.createElement("div"),y=document.createElement("textarea"),E=document.createElement("div");v.innerText=e.basename;let O=!1;const M=function(n,i={cache:!0}){const u=e.absolute_path.slice(0,e.absolute_path.length-e.basename.length);C.file_type(e.absolute_path);let k="avif";const w=u+"."+e.basename.slice(0,e.basename.length-e.ext.length)+k;o=document.createElement("img");let j=null;return i.cache==!0&&s.data_cache_table[w]&&s.cache_flag&&(j=s.data_cache_table[w].cloneNode(),o=j,R&&console.log("hit")),(j==null||i.cache==!1)&&m.exists(w).then(S=>{S?(o.src=l+"loading3.gif",m.get(w,{cache:!1}).then(async D=>{const $=new Blob([D.buffer],{type:"image/"+k});o.dataset.size=D.length,o.src=await C.blob_to_data_url($),s.data_cache_table[w]=o,n(null,o)}).catch(D=>{n(D,o),R&&console.log(D)})):n("Does not exist",o)}).catch(S=>{n("Does not exist",o),console.error(S)}),o};if(e.is_file){if(a=="png"||a=="jpeg"||a=="webp"||a=="avif"||a=="bmp"||a=="gif"||a=="ktx2"){o=document.createElement("img");let n=null;if(s.data_cache_table[e.absolute_path]&&s.cache_flag&&(n=s.data_cache_table[e.absolute_path],o=n,R&&console.log("hit")),n==null){let i=function(){a=="ktx2"?Builder3D.load_texture(e.absolute_path).then(async u=>{C.make_thumbnail_texture_to_image(u,{width:128,height:128},async(k,w)=>{u.dispose();try{const j=await C.to_canvas(w);o.src=j.toDataURL()}catch(j){console.error(j)}o.onload=function(){E.style.display="flex",E.style.justifyContent="center",E.style.alignItems="center";const j=Number(o.dataset.size);let S=`${o.naturalWidth}x${o.naturalHeight}<br>`;j<1024*1024*1?S+=`${Math.ceil(o.dataset.size/1024)} KB`:j<1024*1024*1024?S+=`${Math.ceil(o.dataset.size/1024/1024)} MB`:S+=`${Math.ceil(o.dataset.size/1024/1024/1024)} GB`,E.innerHTML=S},o.onerror=function(j){console.error(j)},s.data_cache_table[e.absolute_path]=o})}).catch(u=>console.error(u)):m.get(e.absolute_path).then(u=>{const k=new Blob([u.buffer],{type:"image/"+a}),w=window.URL.createObjectURL(k);o.onload=function(){window.URL.revokeObjectURL(w),E.style.display="flex",E.style.justifyContent="center",E.style.alignItems="center";const j=Number(o.dataset.size);let S=`${o.naturalWidth}x${o.naturalHeight}<br>`;j<1024*1024*1?S+=`${Math.ceil(o.dataset.size/1024)} KB`:j<1024*1024*1024?S+=`${Math.ceil(o.dataset.size/1024/1024)} MB`:S+=`${Math.ceil(o.dataset.size/1024/1024/1024)} GB`,E.innerHTML=S},o.onerror=function(j){window.URL.revokeObjectURL(w)},o.src=w,s.data_cache_table[e.absolute_path]=o}).catch(u=>{R&&console.log(u)})};o.src=l+"loading3.gif",m.size?m.size(e.absolute_path).then(u=>{if(o.dataset.size=u,u<1024*1024*1)i();else{o.src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=",E.style.display="flex",E.style.justifyContent="center",E.style.alignItems="center",E.style.borderRadius="10px",E.style.outline="1px solid #555";const k=Number(o.dataset.size);k<1024*1024*1?E.innerHTML=`${Math.ceil(o.dataset.size/1024)}+ KB`:k<1024*1024*1024?E.innerHTML=`${Math.ceil(o.dataset.size/1024/1024)}+ MB`:E.innerHTML=`${Math.ceil(o.dataset.size/1024/1024/1024)}+ GB`;const w=document.createElement("i");w.style.cssText="display:inline-block;position:absolute",w.classList.add("bi","bi-image"),o.appendChild(w)}}).catch(u=>console.error(u)):i()}else E.innerHTML=`${o.naturalWidth}x${o.naturalHeight} ${Math.ceil(o.dataset.size/1024)} KB`;o.style.margin="5px",O=!0}else if(a=="tga"){o=document.createElement("img");let n=null;s.data_cache_table[e.absolute_path]&&s.cache_flag&&(n=s.data_cache_table[e.absolute_path],o=n,R&&console.log("hit")),n==null?m.get(e.absolute_path).then(async i=>{await Q(()=>import("./tga@YHfKEhzZ.js"),[],import.meta.url);const u=new window.TgaLoader;u.load(i),o.src=u.getCanvas().toDataURL(),o.dataset.size=i.length,o.onload=function(){E.innerHTML=`${o.naturalWidth}x${o.naturalHeight} ${Math.ceil(o.dataset.size/1024)} KB`},s.data_cache_table[e.absolute_path]=o}).catch(i=>{R&&console.log(i)}):E.innerHTML=`${o.naturalWidth}x${o.naturalHeight} ${Math.ceil(o.dataset.size/1024)} KB`,o.style.margin="5px",O=!0}else a=="png"||a=="jpeg"||a=="webp"||a=="avif"||a=="tiff"||a=="tga"||a=="bmp"||a=="gif"?(o=V("bi-image"),o.style.fontSize="30px"):a=="pmx"||a=="pmd"?(o=document.createElement("img"),o=M((n,i)=>{i.style.margin="5px",n&&(i.src=l+"pmx.backup.png")})):a=="object"?o=M((n,i)=>{i.style.margin="5px",n&&(i.src=l+"object.png")},{cache:f}):a=="material"?o=M((n,i)=>{i.style.margin="5px",n&&(i.src=l+"material.png")}):a=="vpd"||a=="vmd"?(o=document.createElement("img"),o=M((n,i)=>{n&&(i.src=l+"motion.png")}),o.style.margin="5px"):a=="mmd"||a=="ddd"?o=M((n,i)=>{i.style.margin="5px",n&&(i.src=l+"project.png")},{cache:f}):a=="obj"||a=="mtl"?o=M((n,i)=>{i.style.margin="5px",n&&(i.src=l+"obj.png")}):a=="fbx"?o=M((n,i)=>{i.style.margin="5px",n&&(i.src=l+"fbx.png")}):a=="drc"?o=M((n,i)=>{i.style.margin="5px",n&&(i.src=l+"obj.png")}):a=="lwo"?o=M((n,i)=>{i.style.margin="5px",n&&(i.src=l+"lwo.png")}):a=="stl"?o=M((n,i)=>{i.style.margin="5px",n&&(i.src=l+"stl.png")}):a=="dae"?o=M((n,i)=>{i.style.margin="5px",n&&(i.src=l+"dae.png")}):a=="3ds"?o=M((n,i)=>{i.style.margin="5px",n&&(i.src=l+"3ds.svg")}):a=="vrm"?o=M((n,i)=>{i.style.margin="5px",n&&(i.src=l+"gltf.png")}):a=="gltf"||a=="glb"?o=M((n,i)=>{i.style.margin="5px",n&&(i.src=l+"gltf.png")}):a=="blend"?o=M((n,i)=>{i.style.margin="5px",n&&(i.src=l+"blender.svg")}):a=="mp4"||a=="mkv"||a=="mov"||a=="avi"||a=="webm"?(o=V("bi-film"),o.style.fontSize="50px"):a=="mp3"||a=="aac"||a=="aiff"||a=="3gp"||a=="flac"||a=="m4a"||a=="ogg"||a=="wav"||a=="webm"||a=="wma"?(o=V("bi-file-music-fill"),o.style.fontSize="50px"):a=="p12"||a=="key"||a=="cert"||a=="cer"||a=="pem"?(o=V("bi-key"),o.style.fontSize="50px"):a=="js"||a=="ts"||a=="jsm"||a=="html"||a=="css"||a=="scss"||a=="sh"||a=="rb"||a=="py"||a=="cpp"||a=="c"||a=="go"||a=="php"||a=="cs"?(o=V("bi-code"),o.style.fontSize="50px",m.get(e.absolute_path).then(n=>{const i=new TextDecoder;E.innerHTML=i.decode(n).slice(0,50)+"...",E.style.fontSize="10px"})):a=="zip"||a=="gz"||a=="tar"||a=="7z"||a=="bz2"||a=="lz"||a=="rar"?(o=V("bi-file-earmark-zip-fill"),o.style.fontSize="50px",o.style.color="#6B6"):a=="txt"||a=="ini"||a=="json"?(o=V("bi-file-text"),o.style.fontSize="50px",m.get(e.absolute_path).then(n=>{const i=new TextDecoder;E.innerHTML=i.decode(n).slice(0,50)+"...",E.style.fontSize="10px"})):a=="ol"?(o=V("bi-align-justify"),o.style.fontSize="50px"):a=="exe"||a=="bat"?(o=V("bi-window-desktop"),o.style.fontSize="50px",o.style.color="#5AF"):a=="pdf"?o=V("bi-file-pdf"):(o=document.createElement("i"),o.classList.add("bi"),o.classList.add("bi-4x"),o.classList.add("bi-file-richtext-fill"),o.style.fontSize="50px",o.style.margin="5px",o.style.marginBottom="8px");{const n=C.file_type(e.absolute_path);let i=document.createElement("i");if(i.classList.add("bi"),i.style.fontSize="20px",i.style.position="absolute",i.style.left="10px",i.style.top="10px",i.style.textShadow="#000 1px 0 3px",n=="model")i.classList.add("bi-box"),i.style.color="#FA0";else if(n=="motion")i.classList.add("bi-universal-access-circle"),i.style.color="#7A7";else if(n=="pose")i.classList.add("bi-universal-access"),i.style.color="#4A4";else if(n=="sound")i.classList.add("bi-music-note-beamed"),i.style.color="#2AF",i.ondblclick=async function(u){u.preventDefault(),u.stopPropagation()},i.onclick=async function(u){u.preventDefault(),u.stopPropagation();const k=i.classList.contains("bi-volume-up"),w=s.explore_preview_dom.getElementsByClassName("bi-volume-up");for(let j=0;j<w.length;j++){const S=w[j];S.style.color="#2AF",S.classList.remove("bi-volume-up"),S.classList.add("bi-music-note-beamed")}s.event_listener&&await s.event_listener({name:"stop_sound"}),k||(i.style.color="#FA0",i.classList.add("bi-volume-up"),s.event_listener&&await s.event_listener({name:"play_sound",file_path:e.absolute_path,onEnded:()=>{i.style.color="#2AF",i.classList.remove("bi-volume-up"),i.classList.add("bi-music-note-beamed")}}))};else if(n=="image")i.classList.add("bi-image"),i.style.color="#5C7",i.style.fontSize="14px";else if(n=="script")i.classList.add("bi-file-alt"),i.style.color="#FFA",o.style.opacity=.5;else if(n=="etc")i.classList.add("bi-slash-circle-fill");else if(n=="j_object"){const u=C.DPath(e.absolute_path).ext;u=="object"?(i.classList.add("bi-box"),i.style.color="#F5F"):u=="material"?(i.classList.add("bi-slash-circle-fill"),i.style.color="#25F"):(i.classList.add("bi-archive"),i.style.color="#F5F")}else n=="project"&&(i.classList.add("bi-archive-fill"),i.style.color="#F55");_.appendChild(i)}}else if(e.is_directory){const n=document.createElement("i");n.classList.add("bi"),n.classList.add("bi-4x"),n.classList.add("bi-folder-fill"),n.style.color="#7CF",n.style.fontSize="60px",o=n,o.style.margin="5px",o.style.marginBottom="8px"}else o=document.createElement("i"),o.classList.add("bi"),o.classList.add("bi-4x"),o.classList.add("bi-link"),o.style.margin="5px",o.style.marginBottom="8px";o.ondblclick=async function(n){if(R&&R&&console.log("thumb.ondblclick"),e.absolute_path)if(e.is_directory){n.stopPropagation(),s.push_link_stack(e.absolute_path),s.file_browser(e.absolute_path);{const i=document.getElementsByClassName("file_browser_dir_toggle");for(let u=0;u<i.length;u++){const k=i[u];k instanceof HTMLElement&&k.classList.contains("bi-caret-right-fill")&&s.left_directory_collapse_table[k.dataset.absolute_path]&&k.onmouseup(null)}}{const i=document.getElementsByClassName("file_browser_dir_item");for(let u=0;u<i.length;u++){const k=i[u];k instanceof HTMLElement&&k.dataset.absolute_path==e.absolute_path}}}else{n.stopPropagation();const i=e.ext;let u=e.absolute_path;if(i=="zip")if(await C.modal_ok_cancel_promise("Extract",`Do you want to extract?<br>Files will extract into "${t}".`)){const k=[e.absolute_path];await C.sleep(100),C.modal_processing("Processing...."),await C.sleep(100),await C.extract_zip(k),C.close_modal_processing(),await ne(s,t,d),u=k.filter(w=>C.DPath(w).ext=="ddd")[0],u?await C.modal_ok_cancel_promise("Confirmation","Project file found. <br> Do you want to open the project?")||(u=null):u==null?u=k.filter(w=>C.DPath(w).ext=="object")[0]:u==null&&(u=k.filter(w=>C.file_type(w)=="model")[0])}else u=null;u&&s.event_listener&&await s.event_listener({name:"open",absolute_path:u,params:{confirm:!1}})}else e.absolute_path&&e.protocol=="local"},o.style.display="flex",o.classList.add("file_browser_item_thumb"),_.onclick=function(n){R&&console.log(n)},_.ondblclick=function(n){n.stopPropagation(),o.ondblclick(n),R&&console.log(n)},v.classList.add("file_browser_right_panel_item_path"),y.classList.add("file_browser_right_panel_item_path_input"),y.value=v.innerText;let L="block";y.style.display="none",v.style.display=L,y.onblur=function(){y.style.display="none",v.style.display=L},y.onchange=async function(){const n=y.value;if(n.length==0){y.value=v.innerText;return}if(["/","\\","<",">",":","'","?","*"].filter(u=>n.indexOf(u)>=0).length>0){console.error("Invalid char is including.");return}try{C.modal_processing("Processing","");let u=e.absolute_path;if(window.nodejs){const k=window.nodejs.path.dirname(u);u=window.nodejs.path.join(k,y.value)}else u.lastIndexOf("/")!=-1&&(u=u.slice(0,u.lastIndexOf("/"))),u.length&&(u+="/"),u+=y.value;if(await m.move(e.absolute_path,u,e.is_directory,e.is_directory),!e.is_directory){const k=C.make_thumbnail_path(e.absolute_path),w=C.make_thumbnail_path(u);await m.exists(k)&&m.move(k,w)}delete s.data_cache_table[e.absolute_path],e.absolute_path=u,v.innerText=y.value,_.dataset.absolute_path=e.absolute_path,R&&console.log(v.innerText),s.update(!0,!1),C.close_modal_processing()}catch(u){console.error(u),C.close_modal_processing(),C.modal_ok_cancel("Error",`${u}`,{cancel:null})}},v.onmousedown=function(n,i=500){_.classList.contains("active")&&setTimeout(()=>{y.style.display="block",v.style.display="none";const u=y.value=v.innerText;y.focus(),y.setSelectionRange(0,u.lastIndexOf("."))},i),n&&n.stopPropagation()},v.ondblclick=function(n){o.ondblclick(n),n&&n.stopPropagation()},y.onkeydown=function(n){n.key=="Enter"&&(y.blur(),n&&n.stopPropagation())},_.style.width="80px",_.style.height="100px",_.style.margin="5px",_.style.float="left",_.style.display="block-inline",_.style.borderRadius="3px",_.style.position="relative",_.dataset.absolute_path=e.absolute_path,_.dataset.is_directory=e.is_directory;const g=function(n){s.activate_window("preview");const i=n.ctrlKey||n.metaKey||n.shiftKey;if(n.button!=2||c==null||c!=_&&i)if(n.ctrlKey||n.metaKey)h.querySelectorAll(".block").length==0&&(c=_),_.classList.add("active");else if(n.shiftKey){if(c){const u=h.querySelectorAll(".block");let k=!1,w=-1,j=-1;const S=[];for(let D=0;D<u.length;D++){const $=u[D];c==$&&(w=D),_==$&&(j=D),$.classList.remove("active"),S.push($)}w>j&&S.reverse();for(let D=0;D<S.length;D++){const $=S[D];if(c==$&&(k=!0),k&&$.classList.add("active"),_==$){k=!1;break}}}}else{const u=h.querySelectorAll(".block.active");if(u.length<=1||n.button!=2)for(let k=0;k<u.length;k++)u[k].classList.remove("active");_.classList.add("active"),c=_}else{const u=h.querySelectorAll(".block.active");if(n.button==2){let k=!1;for(let w=0;w<u.length;w++)if(u[w].isEqualNode(_)){k=!0;break}if(!k)for(let w=0;w<u.length;w++)u[w].classList.remove("active")}else for(let k=0;k<u.length;k++)u[k].classList.remove("active");_.classList.add("active"),c=_}};_.onmousedown=function(n){n&&n.stopPropagation()},_.onmouseup=function(n){if(A.dom){A.dom.remove(),A.dom=null,n.stopPropagation(),n.preventDefault();return}else g(n);if(n.button==2){R&&console.log("Preview Block-RightClick:",n);const i=[],u=C.file_type(e.absolute_path);if(e.protocol=="local"&&i.push({key:"Open in Folder",callback:()=>{window.nodejs.open_in_finder(e.absolute_path)}}),e.protocol=="local"&&i.push({key:"Open in App",callback:()=>{window.nodejs.open_in_native(e.absolute_path)}}),e.protocol=="local"&&i.push({key:"---",callback:()=>{}}),e.is_directory&&i.push({key:"Open",callback:()=>{s.push_link_stack(e.absolute_path),s.file_browser(e.absolute_path)}}),e.is_directory&&i.push({key:"Open in Asset Browser",callback:async()=>{s.event_listener&&await s.event_listener({name:"open_in_asset_browser",search_path:e.absolute_path})}}),m.driver=="websocketfs"&&(i.push({key:"Open in App",callback:()=>{s.event_listener&&s.event_listener({name:"open_in_app",absolute_path:e.absolute_path})}}),i.push({key:"Open folder in native",callback:()=>{s.event_listener&&s.event_listener({name:"open_folder",absolute_path:e.absolute_path})}})),(u=="model"||u=="j_object"||u=="motion")&&(i.push({key:"Load",callback:()=>{s.event_listener&&s.event_listener({name:"open",absolute_path:e.absolute_path})}}),i.push({key:"Make thumbnail",callback:()=>{s.event_listener&&s.event_listener({name:"make_thumbnail",absolute_path:e.absolute_path})}}),i.push({key:"---",callback:()=>{}})),u=="project"&&(i.push({key:"Change to Absolute Path",callback:()=>{s.event_listener&&s.event_listener({name:"change_to_absolute_path",absolute_path:e.absolute_path})}}),i.push({key:"Change to Relative Path",callback:()=>{s.event_listener&&s.event_listener({name:"change_to_relative_path",absolute_path:e.absolute_path})}}),i.push({key:"Make thumbnail",callback:()=>{s.event_listener&&s.event_listener({name:"make_thumbnail",absolute_path:e.absolute_path})}}),i.push({key:"---",callback:()=>{}})),i.push({key:"Rename",callback:()=>{v.onmousedown(null)}}),i.push({key:"<span style='float:left'>Delete</span><span style='float:right;color:gray'>D</span>",value:"Delete",callback:()=>{const k=document.querySelectorAll(".file_browser_item.active"),w={};for(let S=0;S<k.length;S++){const D=k[S];D instanceof HTMLElement&&(w[D.dataset.absolute_path]=k[S])}w[e.absolute_path]=_;const j=Object.keys(w);R&&console.log(j),C.modal_ok_cancel("Delete",`Are you sure?<br><br>'${e.absolute_path}'(${j.length})<br>It will be deleted without moving to the Trash.`,{},async S=>{S&&setTimeout(async()=>{C.modal_processing("Deleting");try{for(let D=0;D<j.length;D++){const $=w[j[D]];await m.remove($.dataset.absolute_path,$.dataset.is_directory=="true");const B=C.make_thumbnail_path($.dataset.absolute_path);await m.exists(B)&&m.remove(B),R&&console.log(j[D]),$.remove()}C.close_modal_processing()}catch(D){C.close_modal_processing(),C.modal_ok_cancel("Error",D+"",{cancel:null})}s.update(!0,!1)},1)})}}),i.push({key:"Copy",callback:async()=>{const w=window.file_browser.get_selected_items_from("preview").map(j=>({is_directory:j.dataset.is_directory=="true",absolute_path:j.dataset.absolute_path}));await navigator.clipboard.writeText(JSON.stringify({file_browser:!0,contents:w}))}}),m.driver=="webdav"&&(a=="mmd"||a=="ddd")&&i.push({key:"Copy address to project file",callback:async()=>{const k=C.DPath(window.location.href).dirname+"?project="+C.path.join(await m.get_root_url(),e.absolute_path);await navigator.clipboard.writeText(k)}}),i.push({key:"Duplicate",callback:async()=>{let k=1;const w=e.absolute_path.replace(/\\/g,"/"),j=w.indexOf("/")==-1?w:w.slice(w.lastIndexOf("/")+1),S=w.indexOf("/")==-1?"":w.slice(0,w.lastIndexOf("/"));let D=j.lastIndexOf(".")==-1?"":j.slice(j.lastIndexOf("."));const $=S.slice(S.lastIndexOf(".tar.gz"));$==".tar.gz"&&(D=$);function B(){let q=!1;for(const U of P){const J=S+`/${j.slice(0,j.length-D.length)} Copied ${k}${D}`;if(U.absolute_path.replace(/\\/g,"/")==J){k++,q=!0;break}}q&&B()}B();const I=S+`/${j.slice(0,j.length-D.length)} Copied ${k}${D}`;if(await m.copy(e.absolute_path,I,e.is_directory,e.is_directory),!e.is_directory){const q=C.make_thumbnail_path(e.absolute_path),U=C.make_thumbnail_path(I);await m.exists(q)&&m.copy(q,U)}s.file_browser(t)}}),e.protocol!="local"&&(i.push({key:"---",callback:()=>{}}),i.push({key:"Download",callback:async()=>{const k=document.querySelectorAll(".file_browser_item.active"),w=t[t.length-1]=="/"?t:t+"/",j=_.dataset.absolute_path.split("/").pop().split(".").shift();le(k,j,w)}}),e.ext=="zip"&&i.push({key:"Extract",callback:async()=>{await C.extract_zip([e.absolute_path]),s.file_browser(t)}})),e.protocol=="local"&&i.push({key:"---",callback:()=>{}}),e.protocol=="local"&&i.push({key:"Compress",callback:()=>{}}),e.protocol=="local"&&i.push({key:"---",callback:()=>{}}),e.protocol=="local"&&i.push({key:"Property",callback:()=>{}}),window.nodejs&&(window.nodejs.fs,e.is_directory&&(i.push({key:"---",callback:()=>{}}),i.push({key:"Sync to local",callback:()=>{sync_to_local(t,!1)}}))),window.external_io){const k=document.querySelectorAll(".file_browser_item.active"),w=C.DPath(e.absolute_path).ext;k.length==1&&(w=="mmd"||w=="ddd")&&i.push({key:"Move to Scene directory",callback:async()=>{const j=C.path.join(s.entry_point,"Scene"),S=C.DPath(e.absolute_path);await window.cross_file_system.mkdir(j);const D=C.path.join(j,S.basename),$=await window.cross_file_system.read(S.path);if(C.b_decode($).system_flags.absolute_path){await window.cross_file_system.write(D,$),await window.cross_file_system.move(e.absolute_path,D);const I=C.make_thumbnail_path(e.absolute_path);if(await window.cross_file_system.exists(I)){const q=C.path.join(j,C.DPath(I).basename);await window.cross_file_system.move(I,q)}s.file_browser(t)}else C.modal_ok_cancel("Error","Project path setting must be relative. <br> (Absolute Path = false)<br>Reopen and change the flag to false.",{cancel:null})}})}C.popup_menu(n,i,{event_listener:k=>{if(k.button==null&&k.code=="KeyD")for(const w of i)w.value=="Delete"&&w.callback()}},(k,w,j)=>{j.callback()})}n.stopPropagation()},_.onclick=function(n){g(n)},_.draggable=!0,_.ondragstart=oe,e.is_directory&&(_.ondrop=function(n){Z(this,n,s)},_.ondragover=ee,_.ondragleave=W,_.ondragend=W),_.classList.add("file_browser_item"),_.classList.add("file_browser_item_click"),_.appendChild(o),E.style.width="70px",E.style.height="70px",E.style.marginTop="-75px",E.style.marginLeft="7px",E.style.fontSize="12px",E.style.textShadow="1px 1px 2px #000",E.style.overflowWrap="break-word",E.style.overflow="hidden",E.style.color="#FFBB88BB",E.style.fontWeight="bold",O?E.classList.add("file_browser_item_hover"):o.classList.add("file_browser_item_hover"),_.appendChild(E),_.appendChild(v),_.appendChild(y),T.push(_)}h.innerHTML="";for(const e of T)h.appendChild(e);const z=document.createElement("div");z.style.height="50px",z.style.width="100%",z.style.clear="both",h.appendChild(z),h.onclick=function(e){e.target.tagName!="TEXTAREA"&&document.activeElement.tagName=="TEXTAREA"&&document.activeElement.blur()};const A={x1:0,y1:0,x2:0,y2:0,get(){const e={x:0,y:0},_={x:0,y:0};return e.x=this.x1<this.x2?this.x1:this.x2,e.y=this.y1<this.y2?this.y1:this.y2,_.x=this.x1>this.x2?this.x1:this.x2,_.y=this.y1>this.y2?this.y1:this.y2,{start:e,end:_,width:Math.abs(_.x-e.x),height:Math.abs(_.y-e.y)}},event:null,dom:null};h.onmousedown=function(e){e.button==0&&s.deselect_all();const _=document.getElementsByClassName("active_window");for(let a=0;a<_.length;++a)_[a].classList.remove("active_window");if(h.classList.add("active_window"),e.button==0){const a=document.createElement("div");a.style.position="absolute",a.style.backgroundColor="#FFFFFF11",a.style.border="1px dotted #FFFFFF55",A.dom&&(A.dom.remove(),A.dom=null),A.dom=a,A.event=e;{const v=h.getBoundingClientRect(),y=e.clientX-v.left,E=e.clientY-v.top+21;a.style.left=`${y}px`,a.style.top=`${E}px`,A.x1=y,A.y1=E,A.x2=y,A.y2=E,e.stopPropagation(),e.preventDefault()}h.appendChild(A.dom)}};function N(e,_,a,o,v){let y=0;_>o&&(y=_,_=o,o=y),a>v&&(y=a,a=v,v=y);const E=document.querySelectorAll(".file_browser_item"),O=h.scrollTop;a+=O,v+=O;for(let M=0;M<E.length;M++){const L=E[M];if(L instanceof HTMLElement){const g=L.offsetLeft,n=L.offsetTop,i=L.offsetLeft+L.offsetWidth,u=L.offsetTop+L.offsetHeight,k=o>g&&_<i,w=v>n&&a<u;k&&w?L.classList.add("active"):L.classList.remove("active")}}}h.onmousemove=function(e){const a=h.getBoundingClientRect(),o=e.clientX-a.left,v=e.clientY-a.top+21;if(A.dom){const y=A.dom;A.x2=o,A.y2=v;const E=A.get();y.style.left=`${E.start.x}px`,y.style.top=`${E.start.y}px`,y.style.width=`${E.width}px`,y.style.height=`${E.height}px`,N(e,A.x1,A.y1,o,v)}},h.onmouseleave=function(e){A.dom&&(A.dom.remove(),A.dom=null),e.stopPropagation()},h.onmouseup=async function(e){if(R&&console.log(e),A.dom&&(A.dom.remove(),A.dom=null,e.button!=2)){e.stopPropagation();return}if(e.button==2){R&&console.log("explore_preview-right",e);const _=[];_.push({key:"Make a new folder",callback:async()=>{let a=1;const o="New folder ";function v(){let O=!1;for(const M of P){const L=t+"/"+o+a;if(M.absolute_path.replace(/\\/g,"/")==L){a++,O=!0;break}}O&&v()}v();const y=o+a;await m.mkdir(t+"/"+y),s.update();const E=h.querySelectorAll(".file_browser_right_panel_item_path");for(let O=0;O<E.length;O++){const M=E[O];if(M instanceof HTMLElement&&M.innerText==y){console.log("scrollIntoView"),M.parentElement.scrollIntoView({}),M.click();break}}}}),_.push({key:"Open in Asset Browser",callback:async()=>{s.event_listener&&await s.event_listener({name:"open_in_asset_browser",search_path:t})}});{let a=null,o=!1;try{const v=await navigator.clipboard.readText();if(a=JSON.parse(v),a.file_browser)for(const y of a.contents)o=!0}catch{}o&&_.push({key:"Paste",callback:async()=>{let v=null;try{const y=await navigator.clipboard.readText();if(R&&console.log(y),v=JSON.parse(y),v.file_browser)for(const E of v.contents)window.file_browser.copy_file_to_active_window(E.absolute_path,E.is_directory)}catch(y){R&&console.log(y)}}})}C.popup_menu(e,_,null,(a,o,v)=>{v.callback()}),e.stopPropagation()}R&&console.log("explore_preview",e)};{const e=Object.keys(s.data_cache_table);for(let _=e.length;_>=100;_--){const a=e[Math.floor(Math.random()*e.length)];delete s.data_cache_table[a]}}document.body.style.cursor=null}let K=window.debug;const F=function(){this.io=null,this.entry_point=null,this.current_link_stack=0,this.link_stack=[],this.parent_link=null,this.current_link=null,this.data_cache_table={},this.left_dom=null,this.right_dom=null,this.explore_preview_dom=null,this.breadcrumb_dom=null,this.left_directory_collapse_table={},this.event_listener=null,this.cache_flag=!0,this.search_button=null,this.cache_search_table=new Map,this.file_browser_current_path=null,this.directory_browser_current_path=null};window.file_browser_drop_handler=ae;F.prototype.get_items=te;F.prototype.deselect_all=function(){{const s=document.querySelectorAll(".file_browser_item.active");for(let t=0;t<s.length;t++)s[t].classList.remove("active")}{const s=document.querySelectorAll(".file_browser_dir_item.active");for(let t=0;t<s.length;t++)s[t].classList.remove("active")}document.activeElement instanceof HTMLElement&&document.activeElement.blur()};F.prototype.activate_window=function(s){{const t=document.getElementsByClassName("active_window");for(let d=0;d<t.length;d++)t[d].classList.remove("active_window")}s=="preview"?this.explore_preview_dom.classList.add("active_window"):s=="directory"?this.left_dom.classList.add("active_window"):document.activeElement instanceof HTMLElement&&document.activeElement.blur()};F.prototype.get_selected_items_from=function(s){if(s=="preview"){const t=document.querySelectorAll(".file_browser_item.active"),d=[];for(let l=0;l<t.length;++l)d.push(t[l]);return d}else if(s=="directory"){const t=document.querySelectorAll(".file_browser_dir_item.active"),d=[];for(let l=0;l<t.length;++l)d.push(t[l]);return d}return[]};F.prototype.focus_input=function(s){if(s=="preview"){const t=document.querySelectorAll(".file_browser_item.active");if(t[0]instanceof HTMLElement){const d=t[0].querySelector(".file_browser_right_panel_item_path");d instanceof HTMLElement&&d.onmousedown(null,1)}}else if(s=="directory"){K&&console.log("TODO");const t=document.querySelectorAll(".file_browser_dir_item.active > button");t[0]instanceof HTMLElement&&t[0].click()}};F.prototype.focus=function(s){{const t=document.querySelectorAll(".file_browser_item");let d=null;t.forEach(l=>{l.classList.remove("active"),l.dataset.absolute_path==s&&(d=l,l.classList.add("active"))}),d&&d instanceof HTMLElement&&(d.classList.add("active"),d.scrollIntoView({}))}};F.prototype.arrow_key=function(s,t){const d=this;if(s=="preview"){const l=document.querySelectorAll(".file_browser_item"),f=document.querySelectorAll(".file_browser_item.active");if(f.length==0&&l.length>0){l[0].classList.add("active");return}if(t.code=="KeyP"&&(t.ctrlKey||t.metaKey))d.search_button.click();else if(t.code=="ArrowLeft"&&(t.ctrlKey||t.metaKey)){d.back_directory_button();return}else if(t.code=="ArrowRight"&&(t.ctrlKey||t.metaKey)){d.forward_directory_button();return}else if(t.code=="ArrowUp"&&(t.ctrlKey||t.metaKey)){d.parent_directory_button();return}if(f.length>0){if(t.code=="ArrowRight"){const r=f[f.length-1];for(let c=0;c<f.length;c++)f[c].classList.remove("active");let h=null;for(let c=0;c<l.length;c++)if(r.isEqualNode(l[c])){h=l[c+1]?l[c+1]:l[c];break}h&&h.classList.add("active")}else if(t.code=="ArrowDown"){const r=f[f.length-1];if(r instanceof HTMLElement){for(let c=0;c<f.length;c++)f[c].classList.remove("active");let h=null;for(let c=0;c<l.length;c++){const m=l[c];if(m instanceof HTMLElement){if(r.isEqualNode(m))h=m;else if(h)if(r.offsetLeft==m.offsetLeft){h=m;break}else r.offsetTop<m.offsetTop&&(h=m)}}h&&(h.classList.add("active"),console.log("scrollIntoView"),h.scrollIntoView({}))}}else if(t.code=="ArrowLeft"){const r=f[0];for(let c=0;c<f.length;c++)f[c].classList.remove("active");let h=null;for(let c=l.length-1;c>=0;c--)if(r.isEqualNode(l[c])){h=l[c-1]?l[c-1]:l[c];break}h&&h.classList.add("active")}else if(t.code=="ArrowUp"){const r=f[0];for(let c=0;c<f.length;c++)f[c].classList.remove("active");let h=null;for(let c=l.length-1;c>=0;c--){const m=l[c],P=l[c-1];if(r.isEqualNode(m))h=P||m;else if(h&&r instanceof HTMLElement&&m instanceof HTMLElement&&r.offsetLeft==m.offsetLeft){h=m;break}}h&&(h.classList.add("active"),console.log("scrollIntoView"),h.scrollIntoView({}))}}}else if(s=="directory"){const l=document.querySelectorAll(".file_browser_dir_item"),f=document.querySelectorAll(".file_browser_dir_item.active");if(f.length==0&&l.length>0){l[0].classList.add("active");return}if(f.length>0){if(t.code=="ArrowDown"){const r=f[f.length-1];for(let c=0;c<l.length;c++)l[c].classList.remove("active");let h=null;for(let c=0;c<l.length;c++)if(r.isEqualNode(l[c])){h=l[c+1]?l[c+1]:l[c];break}h&&(K&&console.log(h.clientHeight,d.left_dom.scrollHeight,d.left_dom.offsetHeight),h.classList.add("active"),console.log("scrollIntoView"),h.scrollIntoView({})),t&&t.preventDefault()}else if(t.code=="ArrowUp"){const r=f[0];for(let c=0;c<l.length;c++)l[c].classList.remove("active");let h=null;for(let c=l.length-1;c>=0;c--)if(r.isEqualNode(l[c])){h=l[c-1]?l[c-1]:l[c];break}h&&(K&&console.log(d.left_dom.clientHeight,d.left_dom.scrollHeight,d.left_dom.offsetHeight),h.classList.add("active"),console.log("scrollIntoView"),h.scrollIntoView({})),t&&t.preventDefault()}else if(t.code=="ArrowLeft"){let r=f[0];r=r.querySelector(".file_browser_dir_toggle"),r instanceof HTMLElement&&!r.classList.contains("bi-caret-right-fill")&&r.onmouseup?.(null)}else if(t.code=="ArrowRight"){let r=f[0];r=r.querySelector(".file_browser_dir_toggle"),r instanceof HTMLElement&&r.classList.contains("bi-caret-right-fill")&&r.onmouseup?.(null)}}}};F.prototype.select_all=function(s){if(s=="preview"){const t=document.getElementsByClassName("file_browser_item"),d=[];for(let l=0;l<t.length;++l)t[l].classList.add("active"),d.push(t[l]);return d}else if(s=="directory"){const t=document.getElementsByClassName("file_browser_dir_item"),d=[];for(let l=0;l<t.length;++l)d.push(t[l]);return d}return[]};function fe(s,t){const d=t||"/",l=new RegExp(d+"{1,}","g");return s.join(d).replace(l,d)}function _e(s){return s.split("/").pop()}function se(s){const t=s.split("/");return t.pop(),t.join("/")}F.prototype.copy_file_to_active_window=async function(s,t){const d=this,l=d.io,f=document.querySelector(".active_window");let r=null;if(f==null)return;if(f.isEqualNode(d.left_dom))r=d.file_browser_current_path;else if(f.isEqualNode(d.explore_preview_dom))r=d.file_browser_current_path;else return;const h=fe([r,_e(s)]),c=se(s),m=se(h);p.modal_processing("Processing....");try{if(await l.exists(h)==!1||c!=m){const x=s.replace(/\\/g,"/").split("/").pop();let b=d.file_browser_current_path;if(b.length>0&&(b+=b[b.length-1]=="/"?"":"/"),b=p.path.join(b,x),K&&console.log(`"${s}"`,`"${b}"`,t),t&&b.indexOf(s)==0){console.error("Cannot copy into self");return}if(await l.copy(s,b,t,t),!t){const T=p.make_thumbnail_path(s),z=p.make_thumbnail_path(b);await l.exists(T)&&l.copy(T,z)}d.update()}else{let P=1;const x=s.replace(/\\/g,"/"),b=x.indexOf("/")==-1?x:x.slice(x.lastIndexOf("/")+1),T=x.indexOf("/")==-1?"":x.slice(0,x.lastIndexOf("/"));let z=b.lastIndexOf(".")==-1?"":b.slice(b.lastIndexOf("."));const A=T.slice(T.lastIndexOf(".tar.gz"));A==".tar.gz"&&(z=A);const N=await l.list(r),e=function(){let a=!1;for(const o of N){const v=T+`/${b.slice(0,b.length-z.length)} Copied ${P}${z}`;if(o.absolute_path.replace(/\\/g,"/")==v){P++,a=!0;break}}a&&e()};e();const _=T+`/${b.slice(0,b.length-z.length)} Copied ${P}${z}`;await l.copy(s,_,t,t),d.update()}p.close_modal_processing()}catch(P){p.close_modal_processing(),p.modal_ok_cancel("Error",P.toString(),{cancel:null})}};F.prototype.preview=async function(){const s=this,t=document.querySelectorAll(".file_browser_item.active");if(t.length==1&&(p.close_modal_image({force:!0}),p.close_modal_confirmation({force:!0}),document.querySelectorAll(".modalview_modal_image").length==0)){const d=t[0];if(d instanceof HTMLElement&&d.dataset.is_directory!="true"){const l=d.dataset.absolute_path.split(".").pop().toLowerCase();if(l=="jpg"||l=="jpeg"||l=="png"||l=="gif"||l=="tiff"||l=="tga"||l=="bmp"){const f=await s.io.get(d.dataset.absolute_path);if(l=="tga"){await Q(()=>import("./tga@YHfKEhzZ.js"),[],import.meta.url);const r=new window.TgaLoader;r.load(f),p.modal_image(r.getCanvas().toDataURL())}else{let r="";for(let h=0,c=f.byteLength;h<c;h++)r+=String.fromCharCode(f[h]);p.modal_image(`data:image/${l};base64,`+window.btoa(r))}}else if(l=="pmx"){const f=p.DPath(d.dataset.absolute_path),r=p.DPathJoin(f.dirname,await p.make_thumbnail_path(f.basename));if(await s.io.exists(r)){const h=await s.io.get(r);let c="";for(let m=0,P=h.byteLength;m<P;m++)c+=String.fromCharCode(h[m]);p.modal_image(`data:image/${l};base64,`+window.btoa(c))}}else if(l=="txt"){const f=await s.io.get(d.dataset.absolute_path),h=new TextDecoder().decode(f),c=document.createElement("pre");c.style.cssText="width:100%;text-align:left;overflow:scroll;",c.innerText=h,p.modal_ok_cancel_promise(p.DPath(d.dataset.absolute_path).basename,c,{cancel:null,ok:"Close",prevent_input:!1})}}}};F.prototype.open=async function(s){const t=this;if(s==null){const d=this.explore_preview_dom.querySelector(".active");if(d){const l=d.querySelector(".file_browser_item_thumb");if(l){const f=new MouseEvent("dblclick",{view:window,bubbles:!0,cancelable:!0});l.dispatchEvent(f)}}}else s&&(t.push_link_stack(s),t.file_browser(s))};F.prototype.file_browser=async function(s,t={cache:!0}){await ne(this,s,t)};F.prototype.directory_browser=async function(s,t={}){await de(this,s,t)};F.prototype.initialize=async function(s){const t=this;if(t.explore_preview_dom){console.warn("Already initialized");return}const d={entry_point:null,left_dom:null,right_dom:null,io:null,make_dir:!1};Object.assign(d,s);const l=d.io;let f=d.left_dom,r=d.right_dom;const h=d.make_dir;let c=d.entry_point;t.io=l;const m={error:null};if((f==null||r==null||r==f)&&(f=document.createElement("div"),r=document.createElement("div")),c=await l.resolve(c),await l.exists(c,!0)==!1)if(h)K&&console.log("Make dir ws:",c),await l.mkdir(c);else return m.error=`"${c}" does not exist`,m;window.debug&&K&&console.log("Entry point:",c),d.left_directory_collapse_table&&(t.left_directory_collapse_table=d.left_directory_collapse_table),t.entry_point=c,t.left_dom=f,t.right_dom=r,f.innerHTML="",r.innerHTML="";const x=document.createElement("div");x.classList.add("file_browser_right_panel_header");const b=document.createElement("div");b.classList.add("file_browser_explore_preview");const T="file_browser_right_panel_header_icon";{const e=document.createElement("button");e.classList.add(T),e.onclick=()=>{t.back_directory_button()},e.classList.add("bi","bi-arrow-left"),x.appendChild(e)}{const e=document.createElement("button");e.classList.add(T),e.onclick=()=>{t.forward_directory_button()},e.classList.add("bi","bi-arrow-right"),x.appendChild(e)}{const e=document.createElement("button");e.classList.add(T),e.onclick=()=>{t.parent_directory_button()},e.classList.add("bi","bi-arrow-90deg-up"),x.appendChild(e)}{const e=document.createElement("button");e.classList.add(T),e.onclick=()=>{t.sync_directory_button()},e.classList.add("bi","bi-arrow-repeat"),x.appendChild(e)}{const e=document.createElement("button");e.classList.add(T),e.onclick=()=>{t.search_directory_button()},e.classList.add("bi","bi-search"),x.appendChild(e),t.search_button=e}{const e=document.createElement("button");e.classList.add(T),e.onclick=()=>{t.mask_button()},e.classList.add("bi","bi-eye"),x.appendChild(e),t.search_button=e}{const e=document.createElement("button");e.classList.add(T),e.onclick=t.sort_directory_button,e.classList.add("bi","bi-sort-down-alt"),x.appendChild(e)}const z=document.createElement("div");z.classList.add("file_browser_breadcrumb"),z.ondragstart=function(){return!1},x.appendChild(z),t.breadcrumb_dom=z,t.explore_preview_dom=b,r.appendChild(x),r.appendChild(b),r.ondrop=async function(e){await ae(r,e)},r.ondrop2=async function(e){p.modal_processing("Uploading....",""),K&&console.log(e),r.style.opacity=1,e.preventDefault(),e.stopPropagation();const _=e.dataTransfer.getData("json"),a=e.dataTransfer.types.includes("Files"),o=e.dataTransfer.types.includes("json");let v=[];if(o&&_.length>0){const y=JSON.parse(_);v=v.concat(y.target_file_paths)}else if(a)if(e.dataTransfer.items){const y=e.dataTransfer.items,E=[],O=[];if(window.nodejs){const L=window.nodejs.fs;L.promises,window.nodejs.path;for(let g=0;g<e.dataTransfer.files.length;g++){let i=e.dataTransfer.files[g].path;i=i.replace(/\\/g,"/");const u=L.lstatSync(i);if(u.isSymbolicLink()){const w=p.DPath(i).dirname,S=window.nodejs.glob.sync(p.path.join(i,"**/*")),D={};for(const $ of S){D[p.DPath($).dirname]=!0;const B=window.nodejs.fs.lstatSync($).isDirectory();O.push({file_path:$.slice(w.length,$.length),absolute_path:$,is_directory:B})}for(const $ in D){const B=p.DPath($);E.push({absolute_path:B.path,file_path:B.path.slice(w.length,B.path.length)})}}else if(u.isDirectory()){const w=p.DPath(i).dirname,S=window.nodejs.glob.sync(p.path.join(i,"**/*"),{dot:!0,follow:!0}),D={};for(const $ of S){D[p.DPath($).dirname]=!0;const B=window.nodejs.fs.lstatSync($).isDirectory();O.push({file_path:$.slice(w.length,$.length),absolute_path:$,is_directory:B})}for(const $ in D){const B=p.DPath($);E.push({absolute_path:B.path,file_path:B.path.slice(w.length,B.path.length)})}}else{const k=p.DPath(i).dirname,w=i;O.push({file_path:w.slice(k.length,w.length),absolute_path:w})}}}else await te(y,E,O);let M=[];if(E.length>0)for(const L of E)if(t.current_link)if(window.nodejs){const g=p.DPathJoin(t.current_link,L.file_path);K&&console.log(g),await l.mkdir(g)}else{const g=p.DPathJoin(t.current_link,L);K&&console.log(g),await l.mkdir(g,!0)}else M.push(async()=>{});if(await Promise.all(M),M=[],p.close_modal_processing(),O.length>0){p.modal_processing("Uploading","");const L='<progress id="_upload_processing_" max="1" value="0" style="width:100%;margin:0px;padding:0px;height:4px"></progress>';K&&console.log("Uploading");{const g=O.length;let n=0;const i=function(S){return new Promise(function(D,$){if(window.nodejs){const B=window.nodejs.fs,I=p.DPathJoin(t.current_link,S.file_path),q=I.split("/").pop();S.is_directory?D({size:0}):B.readFile(S.absolute_path,async(U,J)=>{if(U){console.error(U),$(U);return}const X=J;let G=!0;if(q[0]=="."?(q.length==1||q[0]=="."&&q[1]=="/")&&(G=!1):q=="Thumbs.db"&&(G=!1),G==!1){D({size:X.length});return}await l.put(I,X),D({size:X.length})})}else{const B=new FileReader;B.onload=async function(I){const q=I.target.result,U=p.DPathJoin(t.current_link,S.file_path),J=U.split("/").pop();let X=!0;J[0]=="."?(J.length==1||J[0]=="."&&J[1]=="/")&&(X=!1):J=="Thumbs.db"&&(X=!1);let G=-1;if(q instanceof ArrayBuffer?G=q.byteLength:typeof q=="string"&&(G=q.length),X==!1){D({size:G});return}await l.put(U,q),D({size:G})},B.onerror=async function(I){$(I)},B.readAsArrayBuffer(S.file)}})};let u=!0;p.modal_processing("Uploading","");const k=function(S){S.update(),p.close_modal_processing()},w=32;let j=0;for(const S of O){p.DPathJoin(t.current_link,S.file_path);const D=function($,B){p.modal_processing_update_description($);const I=document.getElementById("_upload_processing_");I instanceof HTMLProgressElement&&(I.value=B)};u&&(u=!0,D(`${L}<br>${n}/${g} : ${S.file_path}`,n/g));{for(;j>w;)await p.sleep(30);j++,i(S).then($=>{j--,n++,D(`${L}<br>${n}/${g} : ${S.file_path}`,n/g),n==g&&k(t)}).catch($=>{j--,n++,D(`${L}<br>${n}/${g} : ${S.file_path}`,n/g),n==g&&k(t)})}}return}}}else for(let y=0;y<e.dataTransfer.files.length;y++)v.push(e.dataTransfer.files[y])},r.ondragover=function(e){e.preventDefault(),e.stopPropagation(),r.style.opacity=.3},r.ondragenter=function(e){e.preventDefault(),e.stopPropagation(),r.style.opacity=.3},r.ondragend=r.ondragleave=function(e){e.preventDefault(),e.stopPropagation(),r.style.opacity=1},f.dataset.type="file_browser_directory_window",f.addEventListener("mousedown",e=>{{const _=document.querySelectorAll(".file_browser_item.active");for(let a=0;a<_.length;++a)_[a].classList.remove("active")}t.activate_window("directory"),e.stopPropagation()}),f.addEventListener("keydown",e=>{K&&console.log(e)}),r.addEventListener("mousedown",e=>{t.activate_window("preview"),e.stopPropagation()}),t.explore_preview_dom.dataset.type="file_browser_preview_window",t.push_link_stack(c);const A=t.file_browser(c),N=t.directory_browser(c);return await Promise.all([A,N]),m};F.prototype.update=async function(s=!0,t=!0,d=!0){let l=this,f=null,r=null,h=l.cache_flag;l.cache_flag=d,s&&(f=l.directory_browser(l.directory_browser_current_path)),t&&(r=l.sync_directory_button()),f&&await f,r&&await r,l.cache_flag=h};F.prototype.push_link_stack=function(s){this.link_stack=this.link_stack.slice(0,this.current_link_stack),this.current_link_stack++,this.link_stack.push(s)};F.prototype.parent_directory_button=async function(){this.parent_link&&(this.push_link_stack(this.parent_link),await this.file_browser(this.parent_link))};F.prototype.back_directory_button=async function(){if(this.current_link_stack<=1)return;this.current_link_stack--,this.current_link_stack=this.current_link_stack<this.link_stack.length?this.current_link_stack:this.link_stack.length,this.current_link_stack=this.current_link_stack<0?0:this.current_link_stack;const s=this.link_stack[this.current_link_stack-1];s&&(console.warn("Last:",s),await this.file_browser(s))};F.prototype.forward_directory_button=async function(){if(this.current_link_stack>=this.link_stack.length)return;this.current_link_stack++,this.current_link_stack=this.current_link_stack<this.link_stack.length?this.current_link_stack:this.link_stack.length,this.current_link_stack=this.current_link_stack<0?0:this.current_link_stack;const s=this.link_stack[this.current_link_stack-1];s&&await this.file_browser(s)};F.prototype.sync_directory_button=async function(){this.current_link&&await this.file_browser(this.current_link,{cache:!1})};F.prototype.fetch_all=async function(s={}){const t={search_path:s.search_path,cache:!0,recursive:!0};return Object.assign(t,s),console.log("Search:",t.search_path,t),await this.io.list(t.search_path??"/",t)};F.prototype.mask_button=async function(){const s=this;if(this.current_link){let l=function(){s.right_dom.querySelectorAll(".file_browser_explore_preview .file_browser_item").forEach(r=>{p.DPath(r.dataset.absolute_path).basename.toLowerCase().indexOf(d.value.toLowerCase())>=0?r.style.display="":r.style.display="none"})};document.activeElement?.blur?.(),p.modal_processing("Searching",""),this.right_dom.querySelector(".file_browser_opened_search_component")?.remove();const t=document.createElement("div");t.classList.add("file_browser_opened_search_component");const d=document.createElement("input");d.type="search",d.setAttribute("list","file_browser_opened_search_component_data_list"),d.setAttribute("autocomplete","off"),d.ariaLabel="Search file",d.style.paddingLeft="3px",t.appendChild(d),t.style.border="1px solid #8AF",t.style.borderRadius="3px",d.oninput=async f=>{f.preventDefault(),f.stopPropagation(),l()},d.onkeyup=async f=>{!f.isComposing&&f.key==="Enter"&&d.blur()},d.onchange=async f=>{f.preventDefault(),f.stopPropagation();const r=s.right_dom.querySelector(".file_browser_explore_preview .file_browser_item");r&&r.click()},d.onblur=()=>{l(),t.remove()},this.search_button.parentElement.insertBefore(t,this.search_button.nextSibling),d.focus(),p.close_modal_processing()}};F.prototype.search_directory_button=async function(){const s=this;if(this.current_link){document.activeElement?.blur?.(),p.modal_processing("Searching",""),this.right_dom.querySelector(".file_browser_opened_search_component")?.remove();const t=document.createElement("div");t.classList.add("file_browser_opened_search_component");const d=document.createElement("input");d.type="search",d.setAttribute("list","file_browser_opened_search_component_data_list"),d.setAttribute("autocomplete","off"),d.ariaLabel="Search file",d.style.paddingLeft="3px",t.appendChild(d),t.style.border="1px solid #8AF",t.style.borderRadius="3px";const l=document.createElement("datalist");l.id="file_browser_opened_search_component_data_list";let f=null;const r=this.cache_search_table.get(this.current_link);r?(f=r,K&&console.log("Cache hit:",f)):(f=await this.io.list(this.current_link,{recursive:!0}),this.cache_search_table.set(this.current_link,f));const h=p.available_app_exts;f=f.filter(c=>c.basename[0]=="."||c.is_directory?!1:h.filter(m=>m==c.ext).length>0);for(let c=0;c<f.length;c++){const m=f[c],P=document.createElement("option");P.setAttribute("data-value",m.absolute_path),P.value=m.absolute_path;let x=m.basename;switch(p.file_type(x)){case"image":x="🖼️ "+x;break;case"motion":x.toLowerCase().indexOf("camera")>=0?x="🎥 "+x:x="🏃 "+x;break;case"pose":x="🧍 "+x;break;case"j_object":x="🗿 "+x;break;case"project":x="🧰 "+x;break;case"model":x="🗿 "+x;break;case"sound":x="🎵 "+x;break;case"video":x="🎬 "+x;break;case"etc":x="📄 "+x;break;case"script":x="📄 "+x;break;default:x="📄 "+x;break}P.innerText=x,l.appendChild(P)}d.onchange=async c=>{if(d.blur(),d.value.length>0){let m=null;for(const P of f)d.value==P.absolute_path&&(m=P);if(m){let P=m.absolute_path;if(!m.is_directory){const x=m.absolute_path;P=x.indexOf("/")==-1?"":x.slice(0,x.lastIndexOf("/"))}s.push_link_stack(P),await s.file_browser(P),await s.focus(m.absolute_path),K&&console.log("The term searched for was "+d.value)}}c.preventDefault()},d.onblur=()=>{t.remove()},d.appendChild(l),this.search_button.parentElement.insertBefore(t,this.search_button.nextSibling),d.focus(),p.close_modal_processing()}};F.prototype.sort_directory_button=async function(){this.current_link};F.prototype.delete_from=async function(s){const t=this;if(s=="preview"){const d=t.right_dom.querySelectorAll(".file_browser_item.active"),l={};for(let r=0;r<d.length;r++)l[d[r].dataset.absolute_path]=d[r];const f=Object.keys(l);K&&console.log(f),p.modal_processing("Deleting");try{for(let r=0;r<f.length;r++){const h=l[f[r]];await t.io.remove(h.dataset.absolute_path,h.dataset.is_directory=="true");const c=p.make_thumbnail_path(h.dataset.absolute_path);await t.io.exists(c)&&t.io.remove(c),K&&console.log(f[r]),h.remove()}p.close_modal_processing()}catch(r){p.close_modal_processing(),p.modal_ok_cancel("Error",r+"",{cancel:null})}t.update(!0,!1)}else if(s=="directory"){p.modal_processing("Deleting");const d=t.left_dom.querySelectorAll(".file_browser_dir_item.active");try{for(let l=0;l<d.length;l++){const f=d[l];await t.io.remove(f.dataset.absolute_path,f.dataset.is_directory=="true")}p.close_modal_processing()}catch(l){p.close_modal_processing(),p.modal_ok_cancel("Error",l+"",{cancel:null})}t.update()}};export{F as default};
