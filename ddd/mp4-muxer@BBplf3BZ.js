var Ie=Object.defineProperty,me=Object.getOwnPropertySymbols,De=Object.prototype.hasOwnProperty,Ee=Object.prototype.propertyIsEnumerable,z=Math.pow,we=(e,t,i)=>t in e?Ie(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,Pe=(e,t)=>{for(var i in t||={})De.call(t,i)&&we(e,i,t[i]);if(me)for(var i of me(t))Ee.call(t,i)&&we(e,i,t[i]);return e},oe=(e,t,i)=>{if(!t.has(e))throw TypeError("Cannot "+i)},s=(e,t,i)=>(oe(e,t,"read from private field"),i?i.call(e):t.get(e)),h=(e,t,i)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,i)},C=(e,t,i,a)=>(oe(e,t,"write to private field"),a?a.call(e,i):t.set(e,i),i),u=(e,t,i)=>(oe(e,t,"access private method"),i),o=new Uint8Array(8),S=new DataView(o.buffer),_=e=>[(e%256+256)%256],l=e=>(S.setUint16(0,e,!1),[o[0],o[1]]),ze=e=>(S.setInt16(0,e,!1),[o[0],o[1]]),Ce=e=>(S.setUint32(0,e,!1),[o[1],o[2],o[3]]),n=e=>(S.setUint32(0,e,!1),[o[0],o[1],o[2],o[3]]),Be=e=>(S.setUint32(0,Math.floor(e/z(2,32)),!1),S.setUint32(4,e,!1),[o[0],o[1],o[2],o[3],o[4],o[5],o[6],o[7]]),ue=e=>(S.setUint8(0,e),S.setUint8(1,e<<8),[o[0],o[1]]),K=e=>(S.setUint16(0,e,!1),S.setUint16(2,e<<16,!1),[o[0],o[1],o[2],o[3]]),T=(e,t=!1)=>{let i=Array(e.length).fill(null).map((a,r)=>e.charCodeAt(r));return t&&i.push(0),i},D=e=>e&&e[e.length-1],R=(e,t,i=!0)=>{let a=e*t;return i?Math.round(a):a},ye=[65536,0,0,0,65536,0,0,0,1073741824].map(n),m=(e,t,i)=>({type:e,contents:t&&new Uint8Array(t.flat(10)),children:i}),w=(e,t,i,a,r)=>m(e,[_(t),Ce(i),a??[]],r),ke=e=>e?m("ftyp",[T("isom"),n(0),T("iso4"),T("hvc1")]):m("ftyp",[T("isom"),n(0),T("isom"),T("avc1"),T("mp41")]),Le=()=>({type:"mdat",largeSize:!0}),Ne=(e,t)=>m("moov",null,[Fe(t,e),...e.map(i=>Re(i,t))]),Fe=(e,t)=>{let i=R(Math.max(0,...t.filter(r=>r.samples.length>0).map(r=>D(r.samples).timestamp+D(r.samples).duration)),ie),a=Math.max(...t.map(r=>r.id))+1;return w("mvhd",0,0,[n(e),n(e),n(ie),n(i),K(1),ue(1),Array(10).fill(0),ye,Array(24).fill(0),n(a)])},Re=(e,t)=>m("trak",null,[xe(e,t),He(e,t)]),xe=(e,t)=>{let i=D(e.samples),a=R(i?i.timestamp+i.duration:0,ie);return w("tkhd",0,3,[n(t),n(t),n(e.id),n(0),n(a),Array(8).fill(0),l(0),l(0),ue(e.info.type==="audio"?1:0),l(0),ye,K(e.info.type==="video"?e.info.width:0),K(e.info.type==="video"?e.info.height:0)])},He=(e,t)=>m("mdia",null,[Ve(e,t),Xe(e.info.type==="video"?"vide":"soun"),$e(e)]),Ve=(e,t)=>{let i=D(e.samples),a=R(i?i.timestamp+i.duration:0,e.timescale);return w("mdhd",0,0,[n(t),n(t),n(e.timescale),n(a),l(21956),l(0)])},Xe=e=>w("hdlr",0,0,[T("mhlr"),T(e),n(0),n(0),n(0),T("mp4-muxer-hdlr")]),$e=e=>m("minf",null,[e.info.type==="video"?Ge():qe(),Ke(),Je(e)]),Ge=()=>w("vmhd",0,1,[l(0),l(0),l(0),l(0)]),qe=()=>w("smhd",0,0,[l(0),l(0)]),Ke=()=>m("dinf",null,[Ye()]),Ye=()=>w("dref",0,0,[n(1)],[Ze()]),Ze=()=>w("url ",0,1),Je=e=>m("stbl",null,[Qe(e),ht(e),lt(e),ot(e),ut(e),dt(e)]),Qe=e=>w("stsd",0,0,[n(1)],[e.info.type==="video"?je(ft[e.info.codec],e):at(ct[e.info.codec],e)]),je=(e,t)=>m(e,[Array(6).fill(0),l(1),l(0),l(0),Array(12).fill(0),l(t.info.width),l(t.info.height),n(4718592),n(4718592),n(0),l(1),Array(32).fill(0),l(24),ze(65535)],[pt[t.info.codec](t)]),et=e=>e.codecPrivate&&m("avcC",[...e.codecPrivate]),tt=e=>e.codecPrivate&&m("hvcC",[...e.codecPrivate]),it=e=>e.codecPrivate&&m("vpcC",[...e.codecPrivate]),st=e=>e.codecPrivate&&m("av1C",[...e.codecPrivate]),at=(e,t)=>m(e,[Array(6).fill(0),l(1),l(0),l(0),n(0),l(t.info.numberOfChannels),l(16),l(0),l(0),K(t.info.sampleRate)],[vt[t.info.codec](t)]),rt=e=>w("esds",0,0,[n(58753152),_(32+e.codecPrivate.byteLength),l(1),_(0),n(75530368),_(18+e.codecPrivate.byteLength),_(64),_(21),Ce(0),n(130071),n(130071),n(92307584),_(e.codecPrivate.byteLength),...e.codecPrivate,n(109084800),_(1),_(2)]),nt=e=>m("dOps",[_(0),_(e.info.numberOfChannels),l(3840),n(e.info.sampleRate),ue(0),_(0)]),ht=e=>w("stts",0,0,[n(e.timeToSampleTable.length),e.timeToSampleTable.map(t=>[n(t.sampleCount),n(t.sampleDelta)])]),lt=e=>{if(e.samples.every(i=>i.type==="key"))return null;let t=[...e.samples.entries()].filter(([,i])=>i.type==="key");return w("stss",0,0,[n(t.length),t.map(([i])=>n(i+1))])},ot=e=>w("stsc",0,0,[n(e.compactlyCodedChunkTable.length),e.compactlyCodedChunkTable.map(t=>[n(t.firstChunk),n(t.samplesPerChunk),n(1)])]),ut=e=>w("stsz",0,0,[n(0),n(e.samples.length),e.samples.map(t=>n(t.size))]),dt=e=>e.writtenChunks.length>0&&D(e.writtenChunks).offset>=z(2,32)?w("co64",0,0,[n(e.writtenChunks.length),e.writtenChunks.map(t=>Be(t.offset))]):w("stco",0,0,[n(e.writtenChunks.length),e.writtenChunks.map(t=>n(t.offset))]),ft={avc:"avc1",hevc:"hvc1",vp9:"vp09",av1:"av01"},pt={avc:et,hevc:tt,vp9:it,av1:st},ct={aac:"mp4a",opus:"opus"},vt={aac:rt,opus:nt},mt=class{constructor(){this.buffer=null}},_e=class{constructor(e,t,i){this.onData=e,this.onDone=t,this.options=i}},wt=class{constructor(e,t){this.stream=e,this.options=t}},A,P,de=class{constructor(){this.pos=0,h(this,A,new Uint8Array(8)),h(this,P,new DataView(s(this,A).buffer)),this.offsets=new WeakMap}seek(e){this.pos=e}writeU32(e){s(this,P).setUint32(0,e,!1),this.write(s(this,A).subarray(0,4))}writeU64(e){s(this,P).setUint32(0,Math.floor(e/z(2,32)),!1),s(this,P).setUint32(4,e,!1),this.write(s(this,A).subarray(0,8))}writeAscii(e){for(let t=0;t<e.length;t++)s(this,P).setUint8(t%8,e.charCodeAt(t)),t%8===7&&this.write(s(this,A));e.length%8!==0&&this.write(s(this,A).subarray(0,e.length%8))}writeBox(e){var t,i;if(this.offsets.set(e,this.pos),e.contents&&!e.children)this.writeBoxHeader(e,(t=e.size)!=null?t:e.contents.byteLength+8),this.write(e.contents);else{let a=this.pos;if(this.writeBoxHeader(e,0),e.contents&&this.write(e.contents),e.children)for(let p of e.children)p&&this.writeBox(p);let r=this.pos,f=(i=e.size)!=null?i:r-a;this.seek(a),this.writeBoxHeader(e,f),this.seek(r)}}writeBoxHeader(e,t){this.writeU32(e.largeSize?1:t),this.writeAscii(e.type),e.largeSize&&this.writeU64(t)}patchBox(e){let t=this.pos;this.seek(this.offsets.get(e)),this.writeBox(e),this.seek(t)}};A=new WeakMap;P=new WeakMap;var X,I,x,$,ee,Ct=class extends de{constructor(e){super(),h(this,$),h(this,X,void 0),h(this,I,new ArrayBuffer(z(2,16))),h(this,x,new Uint8Array(s(this,I))),C(this,X,e)}write(e){u(this,$,ee).call(this,this.pos+e.byteLength),s(this,x).set(e,this.pos),this.pos+=e.byteLength}finalize(){u(this,$,ee).call(this,this.pos),s(this,X).buffer=s(this,I).slice(0,this.pos)}};X=new WeakMap;I=new WeakMap;x=new WeakMap;$=new WeakSet;ee=function(e){let t=s(this,I).byteLength;for(;t<e;)t*=2;if(t===s(this,I).byteLength)return;let i=new ArrayBuffer(t),a=new Uint8Array(i);a.set(s(this,x),0),C(this,I,i),C(this,x,a)};var k,O,ge=class extends de{constructor(e){super(),h(this,k,void 0),h(this,O,[]),C(this,k,e)}write(e){s(this,O).push({data:e.slice(),start:this.pos}),this.pos+=e.byteLength}flush(){if(s(this,O).length===0)return;let e=[],t=[...s(this,O)].sort((i,a)=>i.start-a.start);e.push({start:t[0].start,size:t[0].data.byteLength});for(let i=1;i<t.length;i++){let a=e[e.length-1],r=t[i];r.start<=a.start+a.size?a.size=Math.max(a.size,r.start+r.data.byteLength-a.start):e.push({start:r.start,size:r.data.byteLength})}for(let i of e){i.data=new Uint8Array(i.size);for(let a of s(this,O))i.start<=a.start&&a.start<i.start+i.size&&i.data.set(a.data,a.start-i.start);s(this,k).onData(i.data,i.start)}s(this,O).length=0}finalize(){var e,t;(t=(e=s(this,k)).onDone)==null||t.call(e)}};k=new WeakMap;O=new WeakMap;var yt=z(2,24),_t=2,L,g,y,Y,te,fe,Te,pe,Se,N,Z,be=class extends de{constructor(e){var t,i;if(super(),h(this,Y),h(this,fe),h(this,pe),h(this,N),h(this,L,void 0),h(this,g,void 0),h(this,y,[]),C(this,L,e),C(this,g,(i=(t=e.options)==null?void 0:t.chunkSize)!=null?i:yt),!Number.isInteger(s(this,g))||s(this,g)<z(2,10))throw new Error("Invalid StreamTarget options: chunkSize must be an integer not smaller than 1024.")}write(e){u(this,Y,te).call(this,e,this.pos),u(this,N,Z).call(this),this.pos+=e.byteLength}finalize(){var e,t;u(this,N,Z).call(this,!0),(t=(e=s(this,L)).onDone)==null||t.call(e)}};L=new WeakMap;g=new WeakMap;y=new WeakMap;Y=new WeakSet;te=function(e,t){let i=s(this,y).findIndex(c=>c.start<=t&&t<c.start+s(this,g));i===-1&&(i=u(this,pe,Se).call(this,t));let a=s(this,y)[i],r=t-a.start,f=e.subarray(0,Math.min(s(this,g)-r,e.byteLength));a.data.set(f,r);let p={start:r,end:r+f.byteLength};if(u(this,fe,Te).call(this,a,p),a.written[0].start===0&&a.written[0].end===s(this,g)&&(a.shouldFlush=!0),s(this,y).length>_t){for(let c=0;c<s(this,y).length-1;c++)s(this,y)[c].shouldFlush=!0;u(this,N,Z).call(this)}f.byteLength<e.byteLength&&u(this,Y,te).call(this,e.subarray(f.byteLength),t+f.byteLength)};fe=new WeakSet;Te=function(e,t){let i=0,a=e.written.length-1,r=-1;for(;i<=a;){let f=Math.floor(i+(a-i+1)/2);e.written[f].start<=t.start?(i=f+1,r=f):a=f-1}for(e.written.splice(r+1,0,t),(r===-1||e.written[r].end<t.start)&&r++;r<e.written.length-1&&e.written[r].end>=e.written[r+1].start;)e.written[r].end=Math.max(e.written[r].end,e.written[r+1].end),e.written.splice(r+1,1)};pe=new WeakSet;Se=function(e){let i={start:Math.floor(e/s(this,g))*s(this,g),data:new Uint8Array(s(this,g)),written:[],shouldFlush:!1};return s(this,y).push(i),s(this,y).sort((a,r)=>a.start-r.start),s(this,y).indexOf(i)};N=new WeakSet;Z=function(e=!1){for(let t=0;t<s(this,y).length;t++){let i=s(this,y)[t];if(!(!i.shouldFlush&&!e)){for(let a of i.written)s(this,L).onData(i.data.subarray(a.start,a.end),i.start+a.start);s(this,y).splice(t--,1)}}};var gt=class extends be{constructor(e){var t;super(new _e((i,a)=>e.stream.write({type:"write",data:i,position:a}),void 0,{chunkSize:(t=e.options)==null?void 0:t.chunkSize}))}},ie=1e3,Tt=["avc","hevc","vp9","av1"],St=["aac","opus"],bt=2082844800,At=.5,Ot=["strict","offset"],d,v,W,U,M,se,J,ae,Ae,re,Oe,ne,Ue,ce,Me,G,he,ve,We,F,Q,H,j,q,le,Ut=class{constructor(e){h(this,ae),h(this,re),h(this,ne),h(this,ce),h(this,G),h(this,ve),h(this,F),h(this,H),h(this,q),h(this,d,void 0),h(this,v,void 0),h(this,W,void 0),h(this,U,null),h(this,M,null),h(this,se,Math.floor(Date.now()/1e3)+bt),h(this,J,!1);var t;if(u(this,ae,Ae).call(this,e),this.target=e.target,C(this,d,Pe({firstTimestampBehavior:"strict"},e)),e.target instanceof mt)C(this,v,new Ct(e.target));else if(e.target instanceof _e)C(this,v,(t=e.target.options)!=null&&t.chunked?new be(e.target):new ge(e.target));else if(e.target instanceof wt)C(this,v,new gt(e.target));else throw new Error(`Invalid target: ${e.target}`);u(this,re,Oe).call(this),u(this,ne,Ue).call(this)}addVideoChunk(e,t,i){let a=new Uint8Array(e.byteLength);e.copyTo(a),this.addVideoChunkRaw(a,e.type,i??e.timestamp,e.duration,t)}addVideoChunkRaw(e,t,i,a,r){if(u(this,q,le).call(this),!s(this,d).video)throw new Error("No video track declared.");u(this,G,he).call(this,s(this,U),e,t,i,a,r)}addAudioChunk(e,t,i){let a=new Uint8Array(e.byteLength);e.copyTo(a),this.addAudioChunkRaw(a,e.type,i??e.timestamp,e.duration,t)}addAudioChunkRaw(e,t,i,a,r){if(u(this,q,le).call(this),!s(this,d).audio)throw new Error("No audio track declared.");u(this,G,he).call(this,s(this,M),e,t,i,a,r)}finalize(){s(this,U)&&u(this,F,Q).call(this,s(this,U)),s(this,M)&&u(this,F,Q).call(this,s(this,M));let e=s(this,v).offsets.get(s(this,W)),t=s(this,v).pos-e;s(this,W).size=t,s(this,v).patchBox(s(this,W));let i=Ne([s(this,U),s(this,M)].filter(Boolean),s(this,se));s(this,v).writeBox(i),u(this,H,j).call(this),s(this,v).finalize(),C(this,J,!0)}};d=new WeakMap;v=new WeakMap;W=new WeakMap;U=new WeakMap;M=new WeakMap;se=new WeakMap;J=new WeakMap;ae=new WeakSet;Ae=function(e){if(e.video&&!Tt.includes(e.video.codec))throw new Error(`Unsupported video codec: ${e.video.codec}`);if(e.audio&&!St.includes(e.audio.codec))throw new Error(`Unsupported audio codec: ${e.audio.codec}`);if(e.firstTimestampBehavior&&!Ot.includes(e.firstTimestampBehavior))throw new Error(`Invalid first timestamp behavior: ${e.firstTimestampBehavior}`)};re=new WeakSet;Oe=function(){var e;let t=((e=s(this,d).video)==null?void 0:e.codec)==="hevc";s(this,v).writeBox(ke(t)),C(this,W,Le()),s(this,v).writeBox(s(this,W)),u(this,H,j).call(this)};ne=new WeakSet;Ue=function(){if(s(this,d).video&&C(this,U,{id:1,info:{type:"video",codec:s(this,d).video.codec,width:s(this,d).video.width,height:s(this,d).video.height},timescale:720,codecPrivate:new Uint8Array(0),samples:[],writtenChunks:[],currentChunk:null,firstTimestamp:void 0,lastTimestamp:-1,timeToSampleTable:[],lastTimescaleUnits:null,compactlyCodedChunkTable:[]}),s(this,d).audio){let e=u(this,ce,Me).call(this,2,s(this,d).audio.sampleRate,s(this,d).audio.numberOfChannels);C(this,M,{id:s(this,d).video?2:1,info:{type:"audio",codec:s(this,d).audio.codec,numberOfChannels:s(this,d).audio.numberOfChannels,sampleRate:s(this,d).audio.sampleRate},timescale:s(this,d).audio.sampleRate,codecPrivate:e,samples:[],writtenChunks:[],currentChunk:null,firstTimestamp:void 0,lastTimestamp:-1,timeToSampleTable:[],lastTimescaleUnits:null,compactlyCodedChunkTable:[]})}};ce=new WeakSet;Me=function(e,t,i){let r=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350].indexOf(t),f=i,p="";p+=e.toString(2).padStart(5,"0"),p+=r.toString(2).padStart(4,"0"),r===15&&(p+=t.toString(2).padStart(24,"0")),p+=f.toString(2).padStart(4,"0");let c=Math.ceil(p.length/8)*8;p=p.padEnd(c,"0");let B=new Uint8Array(p.length/8);for(let b=0;b<p.length;b+=8)B[b/8]=parseInt(p.slice(b,b+8),2);return B};G=new WeakSet;he=function(e,t,i,a,r,f){var p;let c=a/1e6,B=r/1e6;if(e.firstTimestamp===void 0&&(e.firstTimestamp=c),c=u(this,ve,We).call(this,c,e),e.lastTimestamp=c,(!e.currentChunk||c-e.currentChunk.startTimestamp>=At)&&(e.currentChunk&&u(this,F,Q).call(this,e),e.currentChunk={startTimestamp:c,sampleData:[],sampleCount:0}),e.currentChunk.sampleData.push(t),e.currentChunk.sampleCount++,(p=f?.decoderConfig)!=null&&p.description&&(e.codecPrivate=new Uint8Array(f.decoderConfig.description)),e.samples.push({timestamp:c,duration:B,size:t.byteLength,type:i}),e.lastTimescaleUnits!==null){let b=R(c,e.timescale,!1),V=Math.round(b-e.lastTimescaleUnits);e.lastTimescaleUnits+=V;let E=D(e.timeToSampleTable);E.sampleCount===1?(E.sampleDelta=V,E.sampleCount++):E.sampleDelta===V?E.sampleCount++:(E.sampleCount--,e.timeToSampleTable.push({sampleCount:2,sampleDelta:V}))}else e.lastTimescaleUnits=0,e.timeToSampleTable.push({sampleCount:1,sampleDelta:R(B,e.timescale)})};ve=new WeakSet;We=function(e,t){if(s(this,d).firstTimestampBehavior==="strict"&&t.lastTimestamp===-1&&e!==0)throw new Error(`The first chunk for your media track must have a timestamp of 0 (received ${e}). Non-zero first timestamps are often caused by directly piping frames or audio data from a MediaStreamTrack into the encoder. Their timestamps are typically relative to the age of the document, which is probably what you want.

If you want to offset all timestamps of a track such that the first one is zero, set firstTimestampBehavior: 'offset' in the options.
`);if(s(this,d).firstTimestampBehavior==="offset"&&(e-=t.firstTimestamp),e<t.lastTimestamp)throw new Error(`Timestamps must be monotonically increasing (went from ${t.lastTimestamp*1e6} to ${e*1e6}).`);return e};F=new WeakSet;Q=function(e){if(e.currentChunk){e.currentChunk.offset=s(this,v).pos;for(let t of e.currentChunk.sampleData)s(this,v).write(t);e.currentChunk.sampleData=null,(e.compactlyCodedChunkTable.length===0||D(e.compactlyCodedChunkTable).samplesPerChunk!==e.currentChunk.sampleCount)&&e.compactlyCodedChunkTable.push({firstChunk:e.writtenChunks.length+1,samplesPerChunk:e.currentChunk.sampleCount}),e.writtenChunks.push(e.currentChunk),u(this,H,j).call(this)}};H=new WeakSet;j=function(){s(this,v)instanceof ge&&s(this,v).flush()};q=new WeakSet;le=function(){if(s(this,J))throw new Error("Cannot add new video or audio chunks after the file has been finalized.")};export{mt as ArrayBufferTarget,wt as FileSystemWritableFileStreamTarget,Ut as Muxer,_e as StreamTarget};
