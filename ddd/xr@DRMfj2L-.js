const __vite__fileDeps=["./XRControllerModelFactory@JHFsW_iR.js","./ddd@DwDq534T.js","./ddd@CX4D8d_4.css","./GLTFLoader@CYrxnVa8.js","./InteractiveGroup@IhZzUAGC.js","./HTMLMesh@Cw3vxJK3.js"],__vite__mapDeps=i=>i.map(i=>__vite__fileDeps[i]);
import{P as W,G as Me,O as se,B as Ce,V as h,M as re,S as ie,a as ce,L as le,_ as G,E as Y,Q as X}from"./ddd@DwDq534T.js";let de=null,ue=null,he=null,Pe=null;class Z{constructor(s,e){const o={};e&&Object.assign(o,e),this.handControllerListener=s??(r=>{}),this.buildIn3DModel=o.buildIn3DModel??!0,this.defaultController=o.defaultController??!1,this.useHandController=o.useHandController??!1,this.controller=null,this.controllerGrip=null,this.controllerModelFactory=null,this.controller1=null,this.dispose_functions=[],this.html_meshes=[],this.bound_camera=null,this.backup_coord_object=new W,this.group=new Me,this.group.name="XRCtrlGroup",this.keymap={},this.raw=o.raw,this.isAvailable=!1,this.isEntered=!1,this.button=document.createElement("button"),this.KEYS=["Space","KeyP","KeyW","KeyE","KeyQ","KeyA","KeyS","KeyD","KeyR","KeyF","KeyZ"],this.BIND_MAP={},this.event_listeners={},this.session_end_callbacks=[];for(const r of this.KEYS)this.BIND_MAP[r]=!0}getController(s){return DMC.base_renderer.xr.getController(s)}getHand(s){return DMC.base_renderer.xr.getHand(s)}getControllerGrip(s){return DMC.base_renderer.xr.getControllerGrip(s)}_add_scene_object(s,e){this.group.add(s),this.dispose_functions.push(()=>{e?e():this.group.remove(s)})}initialize(s={}){new se}onDocumentKeyDown(s){if(!this.isEntered)return;DMC,this.KEYS;const e=this.keymap;if(this.BIND_MAP[s.code]||s.shiftKey||s.ctrlKey)s.preventDefault(),s.stopPropagation();else return;const r=s.key.toLowerCase();e[r]=!0,console.log("DOWN:",r)}a=(s,e)=>{for(const o of s.children)console.log(o.name.padStart(4*e)),a(o,e+1)};onDocumentKeyUp(s){if(!this.isEntered)return;console.log(s);const e=DMC;this.KEYS;const o=this.keymap,r=this.BIND_MAP,l=s.key.toLowerCase(),c=l=="shift",i=l=="control";if(r[s.code]||c||i)s.preventDefault(),s.stopPropagation();else return;o[l]=!1,l==" "?this.button&&this.button.click():l=="p"?e.playing_state!==e.PLAYING_STATE.PLAYING?e.play():e.stop():l=="z"&&this.reset_camera(!0),console.log("UP:",l)}onBeforeStart(){if(this.raw)return;const s=DMC,e=s.current.camera||s.camera;let o=null;if(this.backup_camera={fov:e.fov,position:e.position.clone(),quaternion:e.quaternion.clone(),target:e.target.clone()},console.log(this.backup_camera.position),e.parent?.getDDDProperties?.()?.isCameraContainer&&e.getCurrentAction()){o=e.parent,this.reset_camera();const i=new se;e.onUpdateCameraAfterAnimated=()=>{o.position.copy(e.position),i.up.set(0,1,0),i.position.copy(e.target),i.lookAt(e.position),o.rotation.setFromQuaternion(i.quaternion),o.position.y-=1.5}}this.container=o,this.bound_camera=e}async onStarted(s){if(this.raw)return;console.log("onStarted XR session");const e=this,o=DMC,r=o.base_renderer,l=o.current.camera||o.camera,c=o.scene,i=new Ce;i.setFromPoints([new h(0,0,0),new h(0,0,-2)]);const n=r.xr.getController(0),t=r.xr.getController(1);e.session_end_callbacks.push(()=>{for(;n.children.length>0;)n.children.pop();for(;t.children.length>0;)t.children.pop()});const b=new re(new ie(.04,50,50),new ce({color:14535850,roughness:.1,metalness:.5})),d=new re(new ie(.04,50,50),new ce({color:14535850,roughness:.1,metalness:.5})),x=new le(i),me=new le(i);b.name="XRSphere1",d.name="XRSphere2",n.name="XRCtrl1",t.name="XRCtrl2",e.buildIn3DModel&&(b.add(x),d.add(me),n.add(b),t.add(d)),this._add_scene_object(n),this._add_scene_object(t);const J=new ue;let F=r.xr.getControllerGrip(0),N=r.xr.getControllerGrip(1);this.useHandController;const fe={a:!1,b:!1,p:!1},_e={a:!1,b:!1,p:!1};function v(p){const R=p.type;if(console.log(p.type,p.data?.handedness,p.data?.gamepad),R!="disconnected")if(R=="connected"){let E=function(y,m,D){const q=D?fe:_e,B=_,S=1,z=2,Q=5,U=ee=>{const te=_,ne=te.position,oe=te.quaternion;console.log(p.data.handedness);const be=oe.clone().multiply(M.clone().invert()),V=new Y().setFromQuaternion(be,"YXZ"),we=V.y;g.push(we),g.length>Q&&g.shift();const De=g.reduce((K,ve)=>K+ve,0)/g.length;V.set(0,-De*S,0);const xe=new X().setFromEuler(V);e.container.quaternion.multiplyQuaternions(xe,e.container.quaternion);const ae=ne.clone().sub(P);ae.applyQuaternion(e.container.quaternion),w.push(ae),w.length>Q&&w.shift(),T.set(0,0,0);for(let K=0;K<w.length;K++)T.add(w[K]);T.divideScalar(w.length),T.multiplyScalar(z),e.container.position.sub(T),P.copy(ne),M.copy(oe)};q[y]!=m&&(q[y]=m,console.log(y,m),y=="a"?m&&DMC.play():y=="b"?m&&e.reset_camera(!0):y=="p"?m&&e.toggle():y=="trigger"||y=="squeeze"&&(P.copy(B.position),M.copy(B.quaternion))),y=="squeeze"&&m&&U()};const f=p.data.handedness=="left",k=p.data.gamepad;let _,u;this==n?(_=n,u=F):(_=t,u=N);const j=p.data.handedness.charAt(0).toUpperCase()+p.data.handedness.slice(1);if(_.name="XRCtrl"+j,e.handControllerListener({state:R,handedness:p.data.handedness,gamepad:k,controller:_,grip:u}),!e.defaultController)return;const M=new X,P=new h,g=[],w=[],T=new h,H=new h,ge=new h,$=new X,ye=new h;this.gamepad=_.gamepad=k;const L=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];_.user.updaters.update=y=>{e.keymap;const m=k?.axes||L,D=k?.buttons||L;let q=m[2]||m[0],B=m[3]||m[1];const S=D[3]?.pressed,z=D[4]?.pressed,Q=D[5]?.pressed;D[6]?.pressed;const U=D[0]?.pressed||D[2]?.pressed,ee=D[1]?.pressed;e.container&&(f?q&&(e.container.rotation.y-=q*.02):(q||B)&&(H.set(q,0,B),l.matrixWorld.decompose(ge,$,ye),H.applyQuaternion($),H.multiplyScalar(.02),e.container.position.add(H)),E("a",z,f),E("b",Q,f),E("p",S,f),E("trigger",U,f),E("squeeze",ee,f))}}else console.warn("Unknown event:",p)}e.session_end_callbacks.push(()=>{n.removeEventListener("connected",v),t.removeEventListener("connected",v),n.removeEventListener("disconnected",v),t.removeEventListener("disconnected",v)}),n.addEventListener("connected",v),t.addEventListener("connected",v),n.addEventListener("disconnected",v),t.addEventListener("disconnected",v),e.buildIn3DModel&&(F.add(J.createControllerModel(F)),N.add(J.createControllerModel(N)));const I=new he;I.listenToPointerEvents(r,l),I.listenToXRControllerEvents(n),I.listenToXRControllerEvents(t),I.name="InteractiveGroup";{const p=new h,R=new h,f=new X,k=new h;I.user.updaters.update=_=>{const u=e.keymap,j=u.shift?.03:.01;if(e.container){let M=0,P=0,g=0;g=g||(u.q?-1:0)||(u.e?1:0),g&&(e.container.rotation.y-=g*j),M=M||(u.a?-1:0)||(u.d?1:0),P=P||(u.w?-1:0)||(u.s?1:0);const w=(u.f?-1:0)||(u.r?1:0);(M||P||w)&&(p.set(M,0,P),l.matrixWorld.decompose(R,f,k),p.applyQuaternion(f),p.y=w,p.multiplyScalar(j),e.container.position.add(p))}}}this._add_scene_object(I),o.stats,document.getElementById("__editor_right_property_window__"),this.reset_camera()}showXRHugeButton(){const s=DMC;if(document.getElementById("center_xr_button")?.remove(),s.scene.isXRMode&&s.base_renderer.xr.getCamera()){console.log("XR:Camera:",s.base_renderer.xr.getCamera());const e=document.querySelector("main").parentElement,o=document.createElement("button");e.appendChild(o),o.style.cssText="padding-left:20px;padding-right:20px;opacity:0.5;border:2px solid #BBB;font-size:20px;border-radius:40px;position:absolute;width:250px;height:50px;bottom:25px;left:0;right:0",o.id="center_xr_button",o.style.margin="auto",o.innerText=this.button.innerText,s.xr.event_listeners.center_button=r=>o.innerText=this.button.innerText,C.no_propagation(o),o.onclick=function(r){s.xr.button&&s.xr.button.onclick?.(r)}}}applyScaling(s,e=void 0){Z.applyScaling(s,e)}static applyScaling(s,e=void 0){const o=DMC,r=o.scene;function l(n,t){if(!(n.getDDDProperties?.()?.isCameraContainer||n instanceof W||n.isCamera))if(window.debug&&console.log(n.name,t),n.isLight){const d=n.target;d&&(d instanceof h?d.multiplyScalar(t):d.scale&&d.scale.multiplyScalar(t)),n.decay*=t<1?2:.5,n.distance*=t,n.shadow?.camera&&(n.shadow.camera.near*=t*t,n.shadow.camera.far*=t,n.shadow.camera.left*=t,n.shadow.camera.right*=t,n.shadow.camera.top*=t,n.shadow.camera.bottom*=t,n.shadow.bias*=t*(t<1?1.5:.6666),n.shadow.normalBias*=t*(t<1?1.5:.6666),n.shadow.map&&(n.shadow.map.needsUpdate=!0),n.shadow.needsUpdate=!0,n.shadow.camera.updateProjectionMatrix()),n.power=n.power*(t<1?.3:3.33333),n.width&&(n.width*=t),n.height&&(n.height*=t),n.position.multiplyScalar(t)}else n.scale&&n.scale.multiplyScalar(t),n.position.multiplyScalar(t)}function c(n,t){if(!n.getDDDProperties?.()?.isCameraContainer&&(n instanceof W||n.isCamera)){const d=n.target;d&&(d instanceof h?d.multiplyScalar(t):d.scale&&d.scale.multiplyScalar(t)),n.position.multiplyScalar(t),n.near*=t*t,n.far*=t;const x=n.getDDDProperties?.();x&&(x.action.distance_scale=t<0?.75:1,x.action.scale=t<0?.34:1),n.updateProjectionMatrix(),n.updateMatrixWorld()}}function i(n){e?(l(e,n),c(e,n)):(r.traverse(t=>c(t,n)),r.children.forEach(t=>l(t,n)),l(o.environment_map_center_helper_object,n))}i(s?.1:10),o.dispatchEvent("change@geometry@denv",{}),o.dispatchEvent("change@scene",{})}render(){for(const s of this.html_meshes)s.material.map.update()}toggle(){this.button&&this.button.click()}store(){const s=DMC;if(this.container){const e=this.container.getDDDProperties();if(e.camera_container={position:this.container.position.clone(),rotation:this.container.rotation.clone()},this.backup_camera){const o=s.current.camera||s.camera;o.position.copy(this.backup_camera.position),o.quaternion.copy(this.backup_camera.quaternion),o.target.copy(this.backup_camera.target),o.fov=this.backup_camera.fov,o.updateProjectionMatrix()}}}reset_camera(s=!1){const e=DMC,o=e.current.camera||e.camera,r=e.scene;if(o.parent==null)return;const l=o.position.clone(),c=o.rotation.clone();this.container=o.parent;const i=this.container.getDDDProperties();if(this.camera_device_pos_offset=l,this.camera_device_rot_offset=c,i)if(this.container.remove(this.group),this.container.add(this.group),this.container.position.copy(l),this.container.rotation.copy(c),i.camera_container&&!s)i.camera_container.rotation&&(i.camera_container.rotation=new Y().copy(i.camera_container.rotation)),i.camera_container.position&&(i.camera_container.position=new h().copy(i.camera_container.position)),this.container.position.set(0,0,0),this.container.quaternion.identity(),this.container.scale.set(1,1,1),this.container.rotation.copy(i.camera_container.rotation),this.container.position.copy(i.camera_container.position),console.log(this.container);else{this.container.position.set(0,0,0),this.container.quaternion.identity(),this.container.scale.set(1,1,1),r.updateMatrixWorld(!0);const n=new h,t=new X,b=new h;o.matrixWorld.decompose(n,t,b);const d=new Y().setFromQuaternion(t,"YXZ");this.container.rotation.y=-d.y,this.container.position.set(0,0,0),this.container.position.sub(n);const x=new h(0,1.5,2);t.invert(),x.applyQuaternion(t),this.container.position.add(x),console.log(this.container)}}onEnded(){if(this.raw)return;const s=DMC,e=this.bound_camera;s.scene.remove(this.group);for(const r of this.dispose_functions)r();if(this.dispose_functions=[],this.html_meshes=[],e.onUpdateCameraAfterAnimated=null,this.container){const r=this.container.getDDDProperties();r.camera_container={position:this.container.position.clone(),rotation:this.container.rotation.clone()},this.container.position.set(0,0,0),this.container.rotation.set(0,0,0),this.container.scale.set(1,1,1)}this.backup_camera&&(e.fov=this.backup_camera.fov,e.position.copy(this.backup_camera.position),e.quaternion.copy(this.backup_camera.quaternion),e.target.copy(this.backup_camera.target),console.log(e.position),e.updateProjectionMatrix(),e.updateMatrixWorld(),console.log("Restored camera",e.fov),dispatchEvent(new Event("resize")),this.backup_camera=null),this.session_end_callbacks.forEach(r=>r()),this.session_end_callbacks=[]}}let pe=!1,A=null;async function qe(O=null,s=null,e=null){if(pe){for(;A==null;)await new Promise(t=>setTimeout(t,100));return A}pe=!0;const o={raw:!1,spaceType:void 0,mode:"XR",buildIn3DModel:!1,useHandController:!1,defaultController:!1,initSession:{}};e&&Object.assign(o,e);const r=DMC,l=r.base_renderer;[{XRButton:de},{XRControllerModelFactory:ue},{InteractiveGroup:he},{HTMLMesh:Pe}]=await Promise.all([G(()=>import("./XRButton@noNxbqF0.js"),[],import.meta.url),G(()=>import("./XRControllerModelFactory@JHFsW_iR.js"),__vite__mapDeps([0,1,2,3]),import.meta.url),G(()=>import("./InteractiveGroup@IhZzUAGC.js"),__vite__mapDeps([4,1,2]),import.meta.url),G(()=>import("./HTMLMesh@Cw3vxJK3.js"),__vite__mapDeps([5,1,2]),import.meta.url)]);const c=A=new Z(s,o);r.addEventListener("before_save@scene",t=>c.store()),o.raw||o.spaceType&&l.xr.setReferenceSpaceType(o.spaceType),l.xr.enabled=!0,o.initSession.mode=o.mode,o.useHandController&&(o.initSession.requiredFeatures?.includes("hand-tracking")||(o.initSession.requiredFeatures||(o.initSession.requiredFeatures=[]),o.initSession.requiredFeatures.push("hand-tracking")));const i=o.raw,n=document.getElementById("main_frame");if(c.button=de.createButton(l,o.initSession,(t,b)=>{t=="before_start"?c.onBeforeStart():t=="started"?(i||(n.style.opacity="0.1"),c.isEntered=!0,c.onStarted(b)):t=="ended"?(c.isEntered=!1,c.onEnded(),n.style.opacity="1.0"):t=="not_supported"||t=="not_allowed"||t=="not_available"?c.isAvailable=!1:t=="available"&&(c.isAvailable=!0);for(const d in c.event_listeners)c.event_listeners[d]();if(!i){const d=document.getElementById("center_xr_button");d&&(d.innerText=c.button.innerText)}O&&O(t)}),!i){const t=document.getElementById("xr_button");t&&(t.appendChild(c.button),t.classList.toggle("hide"))}return O&&O("xr_controller",c),c}export{Z as XRController,qe as XRInitializer};
