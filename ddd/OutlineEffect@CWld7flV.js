import{b as H,c as W,U as N,d as g,e as K}from"./ddd@DwDq534T.js";const c=new THREE.Vector3,h=new THREE.Vector3,M=new THREE.Quaternion,k=new THREE.Quaternion,r=new THREE.Vector3;class D{constructor(i,u={}){this.enabled=!0;const x=u.defaultThickness!==void 0?u.defaultThickness:.003,A=new H().fromArray(u.defaultColor!==void 0?u.defaultColor:[0,0,0]),C=u.defaultAlpha!==void 0?u.defaultAlpha:1,b=u.defaultKeepAlive!==void 0?u.defaultKeepAlive:!1,s={},w=60,d={},f={},S={outlineThickness:{value:x},outlineColor:{value:A},outlineAlpha:{value:C}},y=["#include <common>","#include <uv_pars_vertex>","#include <displacementmap_pars_vertex>","#include <fog_pars_vertex>","#include <morphtarget_pars_vertex>","#include <skinning_pars_vertex>","#include <logdepthbuf_pars_vertex>","#include <clipping_planes_pars_vertex>","uniform float outlineThickness;","vec4 calculateOutline( vec4 pos, vec3 normal, vec4 skinned ) {","	float thickness = outlineThickness;","	const float ratio = 1.0;","	vec4 pos2 = projectionMatrix * modelViewMatrix * vec4( skinned.xyz + normal, 1.0 );","	vec4 norm = normalize( pos - pos2 );","	return pos + norm * thickness * pos.w * ratio;","}","void main() {","	#include <uv_vertex>","	#include <beginnormal_vertex>","	#include <morphnormal_vertex>","	#include <skinbase_vertex>","	#include <skinnormal_vertex>","	#include <begin_vertex>","	#include <morphtarget_vertex>","	#include <skinning_vertex>","	#include <displacementmap_vertex>","	#include <project_vertex>","	vec3 outlineNormal = - objectNormal;","	gl_Position = calculateOutline( gl_Position, outlineNormal, vec4( transformed, 1.0 ) );","	#include <logdepthbuf_vertex>","	#include <clipping_planes_vertex>","	#include <fog_vertex>","}"].join(`
`),T=["#include <common>","#include <fog_pars_fragment>","#include <logdepthbuf_pars_fragment>","#include <clipping_planes_pars_fragment>","uniform vec3 outlineColor;","uniform float outlineAlpha;","void main() {","	#include <clipping_planes_fragment>","	#include <logdepthbuf_fragment>","	gl_FragColor = vec4( outlineColor, outlineAlpha );","	#include <tonemapping_fragment>","	#include <colorspace_fragment>","	#include <fog_fragment>","	#include <premultiplied_alpha_fragment>","}"].join(`
`);function O(){return new W({type:"OutlineEffect",uniforms:N.merge([g.fog,g.displacementmap,S]),vertexShader:y,fragmentShader:T,side:K})}function R(e){let n=s[e.uuid];return n===void 0&&(n={material:O(),used:!0,keepAlive:b,count:0},s[e.uuid]=n),n.used=!0,n.material}function v(e){const n=R(e);return d[n.uuid]=e,z(n,e),n}function _(e){const n=e.geometry,t=n!==void 0&&n.attributes.normal!==void 0;return e.isMesh===!0&&e.material!==void 0&&t===!0}function E(e){if(_(e)!==!1){if(Array.isArray(e.material))for(let n=0,t=e.material.length;n<t;n++)e.material[n]=v(e.material[n]);else e.material=v(e.material);f[e.uuid]=e.onBeforeRender,e.onBeforeRender=B}}function P(e){if(_(e)!==!1){if(Array.isArray(e.material))for(let n=0,t=e.material.length;n<t;n++)e.material[n]=d[e.material[n].uuid];else e.material=d[e.material.uuid];e.onBeforeRender=f[e.uuid]}}function B(e,n,t,l,o){const a=d[o.uuid];a!==void 0&&U(this,t,o,a)}function U(e,n,t,l){const o=l.userData.outlineParameters;if(t.uniforms.outlineAlpha.value=l.opacity,o!==void 0){if(o.thickness!==void 0){let a=1;if(e.skeleton.bones){if(e.skeleton.bone_name_table==null){e.skeleton.bone_name_table={};for(const p of e.skeleton.bones)e.skeleton.bone_name_table[p.name]=p}const m=e.skeleton.bone_name_table.首;if(m==null&&e.skeleton.bone_name_table.センター,m){n.matrixWorld.decompose(c,k,r),m.matrixWorld.decompose(c,M,r),c.copy(c),r.copy(c),h.set(1,0,0),h.applyQuaternion(k),r.add(h),c.project(n),r.project(n);const p=c.distanceTo(r);a=Math.pow(p,.75)*3}}t.uniforms.outlineThickness.value=o.thickness*a}o.color!==void 0&&t.uniforms.outlineColor.value.fromArray(o.color),o.alpha!==void 0&&(t.uniforms.outlineAlpha.value=o.alpha)}l.displacementMap&&(t.uniforms.displacementMap.value=l.displacementMap,t.uniforms.displacementScale.value=l.displacementScale,t.uniforms.displacementBias.value=l.displacementBias)}function z(e,n){if(e.name==="invisible")return;const t=n.userData.outlineParameters;e.fog=n.fog,e.toneMapped=n.toneMapped,e.premultipliedAlpha=n.premultipliedAlpha,e.displacementMap=n.displacementMap,t!==void 0?(n.visible===!1?e.visible=!1:e.visible=t.visible!==void 0?t.visible:!0,e.transparent=t.alpha!==void 0&&t.alpha<1?!0:n.transparent,t.keepAlive!==void 0&&(s[n.uuid].keepAlive=t.keepAlive)):(e.transparent=n.transparent,e.visible=n.visible),(n.wireframe===!0||n.depthTest===!1)&&(e.visible=!1),n.clippingPlanes&&(e.clipping=!0,e.clippingPlanes=n.clippingPlanes,e.clipIntersection=n.clipIntersection,e.clipShadows=n.clipShadows),e.version=n.version}function V(){let e;e=Object.keys(d);for(let n=0,t=e.length;n<t;n++)d[e[n]]=void 0;e=Object.keys(f);for(let n=0,t=e.length;n<t;n++)f[e[n]]=void 0;e=Object.keys(s);for(let n=0,t=e.length;n<t;n++){const l=e[n];s[l].used===!1?(s[l].count++,s[l].keepAlive===!1&&s[l].count>w&&delete s[l]):(s[l].used=!1,s[l].count=0)}}this.render=function(e,n){if(this.enabled===!1){i.render(e,n);return}const t=i.autoClear;i.autoClear=this.autoClear,i.render(e,n),i.autoClear=t,this.renderOutline(e,n)},this.renderOutline=function(e,n){const t=i.autoClear,l=e.matrixWorldAutoUpdate,o=e.background,a=i.shadowMap.enabled;e.matrixWorldAutoUpdate=!1,e.background=null,i.autoClear=!1,i.shadowMap.enabled=!1,e.traverse(E),i.render(e,n),e.traverse(P),V(),e.matrixWorldAutoUpdate=l,e.background=o,i.autoClear=t,i.shadowMap.enabled=a},this.autoClear=i.autoClear,this.domElement=i.domElement,this.shadowMap=i.shadowMap,this.clear=function(e,n,t){i.clear(e,n,t)},this.getPixelRatio=function(){return i.getPixelRatio()},this.setPixelRatio=function(e){i.setPixelRatio(e)},this.getSize=function(e){return i.getSize(e)},this.setSize=function(e,n,t){i.setSize(e,n,t)},this.setViewport=function(e,n,t,l){i.setViewport(e,n,t,l)},this.setScissor=function(e,n,t,l){i.setScissor(e,n,t,l)},this.setScissorTest=function(e){i.setScissorTest(e)},this.setRenderTarget=function(e){i.setRenderTarget(e)}}}export{D as OutlineEffect};
